# JSON ê¸°ë°˜ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (f06) - ê¸°ìˆ  ì¸í”„ë¼ ë ˆì´ì–´

## ğŸ“‹ **ë¬¸ì„œ ëª©ì **

ì´ ë¬¸ì„œëŠ” **Caretì˜ í•˜ì´ë¸Œë¦¬ë“œ í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤. JSONê³¼ Cline ì›ë³¸ ì‹œìŠ¤í…œì„ ì„ íƒì ìœ¼ë¡œ í™œìš©í•˜ì—¬ íš¨ìœ¨ì„±ê³¼ ì•ˆì •ì„±ì„ ë™ì‹œì— ë‹¬ì„±í•œ f06 ê¸°ìˆ  ì¸í”„ë¼ì˜ ì„¤ê³„ ì² í•™, êµ¬í˜„ ë°©ì‹, í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤.

**ëŒ€ìƒ ë…ì**: Caret ê°œë°œíŒ€, ì‹œìŠ¤í…œ ì•„í‚¤í…íŠ¸, í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œ ê°œë°œì

---

**ì—­í• **: f07 Chatbot/Agent ì‚¬ìš©ì ê²½í—˜ì˜ **ê¸°ìˆ ì  ê¸°ë°˜**ì„ ì œê³µí•˜ëŠ” ì¸í”„ë¼ ë ˆì´ì–´  
**ë°©ì‹**: JSON + Cline ì›ë³¸ í•˜ì´ë¸Œë¦¬ë“œ ì‹œìŠ¤í…œ  
**êµ¬í˜„ ìƒíƒœ**: âœ… **ì™„ë£Œ** - f07ê³¼ í•¨ê»˜ ìš´ì˜ ì¤‘  

## ğŸ¯ **f06ì˜ ì—­í• : ê¸°ìˆ  ì¸í”„ë¼ ì œê³µ**

f06ì€ **ì‚¬ìš©ì ê²½í—˜ì„ ë‹´ë‹¹í•˜ëŠ” f07ì˜ ê¸°ìˆ ì  ê¸°ë°˜**ì„ ì œê³µí•©ë‹ˆë‹¤:

```typescript
// f07(ì‚¬ìš©ì ê²½í—˜) + f06(ê¸°ìˆ  ì¸í”„ë¼) í•˜ì´ë¸Œë¦¬ë“œ êµ¬ì¡°
if (currentMode === "caret") {
    // ì‚¬ìš©ìëŠ” "Agent Mode" ê²½í—˜ (f07)
    // ê¸°ìˆ ì ìœ¼ë¡œëŠ” CaretPromptWrapper ì‚¬ìš© (f06)
    return await CaretPromptWrapper.getCaretSystemPrompt(context)
} else {
    // ê¸°ì¡´ Cline ì‹œìŠ¤í…œ 100% ë³´ì¡´
    return await registry.get(context)
}
```

### **f06 + f07 í•˜ì´ë¸Œë¦¬ë“œ ì¥ì **

1. **ì•ˆì „ì„±**: Cline ì½”ì–´ ë¡œì§ ì™„ì „ ë³´ì¡´
2. **ì‚¬ìš©ì ê²½í—˜**: ì§ê´€ì ì¸ chatbot/agent ìš©ì–´ (f07)  
3. **ìœ ì§€ë³´ìˆ˜**: ìµœì†Œí•œì˜ Cline íŒŒì¼ ìˆ˜ì • (3-5ê°œ)

## ğŸ—ï¸ **í˜„ì¬ êµ¬í˜„ëœ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**

### **í•µì‹¬ êµ¬í˜„ ì»´í¬ë„ŒíŠ¸**

```
caret-src/core/
â”œâ”€â”€ modes/CaretModeManager.ts       # ëª¨ë“œ ìƒíƒœ ê´€ë¦¬ (globalState)
â”œâ”€â”€ prompts/CaretPromptWrapper.ts   # ë…ë¦½ì  í”„ë¡¬í”„íŠ¸ ìƒì„±
â””â”€â”€ controller/caretSystem/         # gRPC ì„œë¹„ìŠ¤ êµ¬í˜„
    â”œâ”€â”€ SetCaretMode.ts
    â””â”€â”€ GetCaretMode.ts
```

### **ë„êµ¬ ì œí•œ ì‹œìŠ¤í…œ**

```typescript
// CaretModeManagerì—ì„œ ë„êµ¬ ê¶Œí•œ ê´€ë¦¬
static isToolAllowed(toolName: string): boolean {
    const allowed = this.caretMode === "agent" || (() => {
        if (this.caretMode === "chatbot") {
            // CHATBOT ëª¨ë“œ: ì½ê¸° ì „ìš© ë„êµ¬ë§Œ
            const allowedInChatbot = [
                "read_file", "list_files", "search_files",
                "list_code_definition_names", "ask_followup_question",
                "web_fetch", "attempt_completion"
            ]
            return allowedInChatbot.includes(toolName)
        }
        return false
    })()
    
    return allowed
}
```

## ğŸ“Š **ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ**

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  | êµ¬í˜„ ë°©ì‹ |
|----------|------|----------|
| **CaretJsonAdapter** | í•˜ì´ë¸Œë¦¬ë“œ í”„ë¡¬í”„íŠ¸ ìƒì„± | JSON ì„¹ì…˜ + Cline ë„êµ¬ í†µí•© |
| **CaretModeManager** | ëª¨ë“œ ìƒíƒœ ê´€ë¦¬ | globalState ê¸°ë°˜ ë‹¨ì¼ ì €ì¥ì†Œ |
| **CaretPromptWrapper** | í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œ ì§„ì…ì  | ë…ë¦½ì  í”„ë¡¬í”„íŠ¸ ìƒì„± |
| **gRPC ì„œë¹„ìŠ¤** | ëª¨ë“œ ì œì–´ ì¸í„°í˜ì´ìŠ¤ | SetCaretMode/GetCaretMode |

## ğŸ”§ **í•˜ì´ë¸Œë¦¬ë“œ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**

### **CaretJsonAdapter - í•˜ì´ë¸Œë¦¬ë“œ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸°**

ìµœì¢… êµ¬í˜„ëœ ì‹œìŠ¤í…œì˜ í•µì‹¬ì€ **ì„ íƒì  ê¸°ìˆ  í™œìš©**ì…ë‹ˆë‹¤:

```typescript
// CaretJsonAdapter.ts - í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²•
export class CaretJsonAdapter implements PromptAdapter {
    async generatePrompt(context: CaretSystemPromptContext): Promise<string> {
        // 1. JSON ì‹œìŠ¤í…œ í™œìš© ì˜ì—­ (ë‹¨ìˆœí•œ ì •ì  ì»¨í…ì¸ )
        const baseIntro = await this.getJsonSection("BASE_PROMPT_INTRO")
        const modeSystem = await this.getJsonSection("CHATBOT_AGENT_MODES") 
        const systemInfo = await this.getJsonSection("CARET_SYSTEM_INFO")
        
        // 2. Cline ì›ë³¸ í™œìš© ì˜ì—­ (ë³µì¡í•œ ë„êµ¬ ì •ì˜)
        const toolsSection = await this.getClineToolsSection(context, isChatbotMode)
        
        return [baseIntro, modeSystem, toolsSection, systemInfo].join('\n\n')
    }
    
    // í•µì‹¬: Clineì˜ ì™„ì „í•œ ë„êµ¬ ì‹œìŠ¤í…œ í™œìš©
    private async getClineToolsSection(context: CaretSystemPromptContext): Promise<string> {
        // ëª¨ë“  ë„êµ¬ ì •ì˜ ë¡œë“œ (browser_action, execute_command ë“±ì˜ ì™„ì „í•œ íŒŒë¼ë¯¸í„° í¬í•¨)
        await PromptRegistry.getInstance().load()
        
        // CARET MODIFICATION: ModelFamily í˜¸í™˜ì„± ë³´ì¥
        const mockVariant = {
            // ModelFamily.GENERIC ê°•ì œ ì„¤ì •ìœ¼ë¡œ ëª¨ë“  ê¸°ë³¸ ë„êµ¬ ë¡œë“œ
            // next-gen ë“± ì‹ ê·œ ëª¨ë¸ íŒ¨ë°€ë¦¬ëŠ” ì•„ì§ ë„êµ¬ variantê°€ ì—†ìŒ
            family: ModelFamily.GENERIC,
            tools: [] as readonly ClineDefaultTool[],  // ë¹ˆ ë°°ì—´ë¡œ ì „ì²´ ë„êµ¬ ìë™ ë¡œë“œ
            // ... ê¸°íƒ€ í•„ìˆ˜ í•„ë“œë“¤
        }
        
        const toolPrompts = await PromptBuilder.getToolsPrompts(mockVariant, context)
        
        // Caret ëª¨ë“œë³„ í•„í„°ë§ ì ìš©
        return this.filterToolsByMode(toolPrompts, isChatbotMode)
    }
}
```

### **ê¸°ìˆ  ì„ íƒ ê¸°ì¤€**

| ì˜ì—­ | ê¸°ìˆ  ì„ íƒ | ì„ íƒ ì´ìœ  |
|------|----------|----------|
| **ëª¨ë“œ ì„¤ëª…** | JSON | `AGENT_BEHAVIOR_DIRECTIVES.json`ì—ì„œ ê´€ë¦¬ |
| **ë„êµ¬ ì •ì˜** | Cline ì›ë³¸ | ë³µì¡í•œ íŒŒë¼ë¯¸í„°, ë™ì  ê²€ì¦ ë¡œì§ |
| **ì‹œìŠ¤í…œ ì •ë³´** | JSON | `CARET_SYSTEM_INFO.json`ì—ì„œ ê´€ë¦¬ |
| **í–‰ë™ ê·œì¹™** | JSON | `AGENT_BEHAVIOR_DIRECTIVES.json`ì—ì„œ ê´€ë¦¬ |

## ğŸ¯ **ModelFamily ë„êµ¬ ì‹œìŠ¤í…œ ë¶„ì„**

### **ë„êµ¬ ë¡œë”© ë¬¸ì œ ë¶„ì„ ë° í•´ê²°**

Clineì˜ ë„êµ¬ ì‹œìŠ¤í…œì€ **ModelFamilyë³„ë¡œ ë‹¤ë¥¸ ë„êµ¬ variant**ë¥¼ ì œê³µí•˜ì—¬ ëª¨ë¸ íŠ¹ì„±ì— ë§ëŠ” ìµœì í™”ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

#### **1. ModelFamily êµ¬ë¶„ ì´ìœ **
```typescript
// src/core/prompts/system-prompt/tools/execute_command.ts
const generic: ClineToolSpec = {
    variant: ModelFamily.GENERIC,
    name: "execute_command",
    parameters: [
        {
            name: "requires_approval",
            required: true,  // ê¸°ë³¸ ëª¨ë¸: ìŠ¹ì¸ í•„ìˆ˜
        }
    ]
}

const gpt: ClineToolSpec = {
    variant: ModelFamily.GPT, 
    name: "bash",  // GPTëŠ” ë‹¤ë¥¸ ì´ë¦„ ì‚¬ìš©
    parameters: [
        {
            name: "requires_approval",
            required: false,  // GPT: ìŠ¹ì¸ ì„ íƒì‚¬í•­ (ë” ììœ¨ì )
        }
    ]
}
```

#### **2. ë„êµ¬ variant ë¶„í¬ í˜„í™©**
```typescript
// ë„êµ¬ë³„ ì§€ì› ModelFamily ë¶„ì„
browser_action: [GENERIC]                    // âŒ next-gen ë¯¸ì§€ì›
execute_command: [GENERIC, GPT]              // âŒ next-gen ë¯¸ì§€ì›  
read_file: [GENERIC, NEXT_GEN, GPT, GEMINI] // âœ… next-gen ì§€ì›
ask_followup_question: [GENERIC, GPT]        // âŒ next-gen ë¯¸ì§€ì›
```

#### **3. ë¬¸ì œ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤**
```typescript
// Gemini 2.5 ë“± next-gen ëª¨ë¸ ì‚¬ìš©ì‹œ
const modelFamily = getModelFamily(providerInfo) // â†’ "next-gen"
const tools = ClineToolSet.getTools(modelFamily) // â†’ MCP ë„êµ¬ë“¤ë§Œ 7ê°œ ë°˜í™˜
// browser_action, execute_command ë“±ì€ GENERIC/GPTì—ë§Œ ìˆì–´ì„œ ëˆ„ë½
```

#### **4. CaretJsonAdapter í•´ê²°ì±…**
```typescript
// CARET MODIFICATION: next-gen ëª¨ë¸ í˜¸í™˜ì„±
const mockVariant = {
    // ê°•ì œë¡œ GENERIC ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ê¸°ë³¸ ë„êµ¬ ë¡œë“œ
    family: ModelFamily.GENERIC,  
    tools: [],  // ë¹ˆ ë°°ì—´ â†’ ClineToolSet.getTools(GENERIC) í˜¸ì¶œ
}

// ê²°ê³¼: browser_action, execute_command ë“± ëª¨ë“  ê¸°ë³¸ ë„êµ¬ ë¡œë“œ ì„±ê³µ
const toolPrompts = await PromptBuilder.getToolsPrompts(mockVariant, context)
```

#### **5. ëª¨ë¸ë³„ ë„êµ¬ ì°¨ì´ì  ë¶„ì„**
| ëª¨ë¸ íŒ¨ë°€ë¦¬ | ë„êµ¬ íŠ¹ì§• | ì˜ˆì‹œ |
|------------|----------|------|
| **GENERIC** | ë³´ìˆ˜ì , ìŠ¹ì¸ í•„ìˆ˜ | `requires_approval: true` |
| **GPT** | ììœ¨ì , ë‹¤ë¥¸ ì´ë¦„ ì‚¬ìš© | `bash` vs `execute_command` |
| **NEXT_GEN** | ì¼ë¶€ ë„êµ¬ë§Œ ìµœì í™” | `read_file` ì •ë„ë§Œ ì§€ì› |
| **GEMINI** | ê¸°ë³¸ ë„êµ¬ë“¤ ì§€ì› | GENERICê³¼ ìœ ì‚¬ |

#### **6. íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ**
```typescript
// ë„êµ¬ ëˆ„ë½ ë¬¸ì œ ì§„ë‹¨
DEBUG [CaretJsonAdapter] family=next-gen, toolPrompts=7  // âŒ ë¬¸ì œ ìƒí™©
DEBUG [CaretJsonAdapter] family=GENERIC, toolPrompts=15+ // âœ… í•´ê²° í›„
```

## ğŸ”§ **í•µì‹¬ êµ¬í˜„ ì»´í¬ë„ŒíŠ¸**

### **1. CaretModeManager (ëª¨ë“œ ìƒíƒœ ê´€ë¦¬)**
```typescript
export class CaretModeManager {
    private static caretMode: "chatbot" | "agent" = "agent"
    private static context: vscode.ExtensionContext | undefined = undefined

    static async initialize(): Promise<void> {
        // globalStateì—ì„œ ëª¨ë“œ ë¡œë“œ
        const savedMode = this.context.globalState.get<"chatbot" | "agent">("caret.mode", "agent")
        this.caretMode = savedMode
    }

    static async setCaretMode(mode: "chatbot" | "agent"): Promise<void> {
        this.caretMode = mode
        // globalStateì— ì €ì¥
        await this.context.globalState.update("caret.mode", mode)
    }
}
```

### **2. CaretPromptWrapper (í”„ë¡¬í”„íŠ¸ ìƒì„±)**
```typescript
export class CaretPromptWrapper {
    static async getCaretSystemPrompt(context: SystemPromptContext): Promise<string> {
        // CaretModeManagerì—ì„œ í˜„ì¬ ëª¨ë“œ ì¡°íšŒ
        const caretMode = CaretModeManager.getCurrentCaretMode()
        
        // ëª¨ë“œë³„ í”„ë¡¬í”„íŠ¸ ìƒì„± ë¡œì§
        return await this.promptManager.getPrompt({
            ...context,
            mode: caretMode === "chatbot" ? CARET_MODES.CHATBOT : CARET_MODES.AGENT
        })
    }
}
```

## ğŸ”„ **Cline í˜¸í™˜ì„± ë³´ì¥**

### **ìµœì†Œ ìˆ˜ì • ì›ì¹™**
í˜„ì¬ êµ¬í˜„ëœ Cline íŒŒì¼ ìˆ˜ì • ì‚¬í•­:

```typescript
// ìˆ˜ì •ëœ Cline íŒŒì¼: 3ê°œ
1. src/core/prompts/system-prompt/index.ts - CaretPromptWrapper ë¶„ê¸°
2. src/extension.ts - CaretModeManager ì´ˆê¸°í™”
3. webview-ui/src/context/ExtensionStateContext.tsx - localStorage ë™ê¸°í™”

// ì™„ì „ ë…ë¦½ êµ¬í˜„: caret-src/ ë””ë ‰í† ë¦¬
- CaretModeManager.ts
- CaretPromptWrapper.ts  
- gRPC ì„œë¹„ìŠ¤ë“¤
```

### **ê¸°ì¡´ Cline ì‚¬ìš©ì ë³´í˜¸**
```typescript
// system-prompt/index.ts ë¶„ê¸° ë¡œì§
if (currentMode === "caret") {
    const { CaretPromptWrapper } = await import("@caret/core/prompts/CaretPromptWrapper")
    return await CaretPromptWrapper.getCaretSystemPrompt(context)
} else {
    return await registry.get(context) // ê¸°ì¡´ Cline ë™ì‘ 100% ë³´ì¡´
}
```

## ğŸ“ˆ **í˜„ì¬ êµ¬í˜„ ìƒíƒœ**

### **ì™„ë£Œëœ ê¸°ëŠ¥** âœ…
- **ëª¨ë“œ ê´€ë¦¬**: CaretModeManager (globalState ê¸°ë°˜)
- **í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œ**: CaretPromptWrapper (ë…ë¦½ì  ìƒì„±)
- **ë„êµ¬ ì œí•œ**: isToolAllowed ë©”ì„œë“œ
- **gRPC í†µì‹ **: SetCaretMode/GetCaretMode ì„œë¹„ìŠ¤
- **UI ë™ê¸°í™”**: ExtensionStateContext localStorage ë™ê¸°í™”
- **Cline í˜¸í™˜ì„±**: 100% ë³´ì¡´

## ğŸ”§ **ê¸°ìˆ ì  íŠ¹ì§•**

### **1. ë‹¨ì¼ ê²½ë¡œ í†µí•©**
- **globalState**: ëª¨ë“  ëª¨ë“œ ìƒíƒœ ê´€ë¦¬ í†µí•©
- **ExtensionStateContext**: ì›¹ë·°ì™€ ë°±ì—”ë“œ ë™ê¸°í™”
- **ì¤‘ë³µ ì œê±°**: VS Code config ì œê±°ë¡œ ë‹¨ì¼ ì €ì¥ì†Œ ë‹¬ì„±

### **2. ì•ˆì „í•œ ë¶„ê¸°**
- **ìµœì†Œ ì¹¨ìŠµ**: 3ê°œ íŒŒì¼ë§Œ ìˆ˜ì •ìœ¼ë¡œ Cline ì•ˆì •ì„± í™•ë³´
- **ì™„ì „ ë¶„ë¦¬**: caret-src ë””ë ‰í† ë¦¬ë¡œ ë…ë¦½ êµ¬í˜„
- **í›„ì§„ í˜¸í™˜**: ê¸°ì¡´ Cline ì‚¬ìš©ì ì›Œí¬í”Œë¡œìš° 100% ë³´ì¡´

---

## ğŸ”— **ê´€ë ¨ ë¬¸ì„œ**

- **[f07-chatbot-agent.mdx](./f07-chatbot-agent.mdx)**: ì‚¬ìš©ì ê²½í—˜ ë ˆì´ì–´
- **[t06-phase5-1-caret-mode-fix.md](../work-logs/luke/t06-phase5-1-caret-mode-fix.md)**: í†µí•© êµ¬í˜„ ê³„íš
- **[caret-architecture-and-implementation-guide.mdx](../development/caret-architecture-and-implementation-guide.mdx)**: ì „ì²´ ì•„í‚¤í…ì²˜ ê°€ì´ë“œ
