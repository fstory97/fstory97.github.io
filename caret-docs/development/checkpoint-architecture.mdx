---
title: "체크포인트 아키텍처 가이드"
description: "Caret의 체크포인트 기능이 내부적으로 어떻게 동작하는지 설명합니다."
---

import { Callout } from "nextra/components"

# 체크포인트 아키텍처 가이드

이 문서는 Caret의 **체크포인트** 기능의 내부 아키텍처와 핵심 동작 원리를 설명합니다. 이 기능은 사용자가 AI와 상호작용하는 동안 코드 변경 사항을 자동으로 추적하고, 필요한 경우 이전 상태로 쉽게 복원할 수 있도록 지원합니다.

## 핵심 컨셉: Shadow Git

체크포인트 기능의 가장 중요한 컨셉은 **"Shadow Git"** 입니다.

- **독립된 저장소:** 사용자의 메인 `.git` 저장소와는 완전히 독립된, 숨겨진 Git 저장소를 임시 디렉토리(`~/.vscode/globalStorage/...`)에 생성합니다.
- **충돌 방지:** 이 방식을 통해, 체크포인트 생성/복원 작업이 사용자의 커밋 히스토리나 현재 작업 상태에 전혀 영향을 주지 않습니다.
- **자동 관리:** 체크포인트는 AI와의 상호작용(Task) 단위로 생성되며, 각 Task는 Shadow Git 내에서 고유한 커밋으로 기록됩니다.

## 주요 동작 흐름

체크포인트 생성은 다음과 같은 단계로 이루어집니다.

1.  **초기화 (`CheckpointTracker.create`):**
    - 사용자의 시스템에 Git이 설치되어 있는지 확인합니다. (필수 조건)
    - 현재 작업 공간(Workspace)을 기준으로 고유한 Shadow Git 저장소 경로를 생성합니다.
    - 만약 Shadow Git 저장소가 없다면, `git init`을 통해 새로 생성하고 초기 설정을 구성합니다. (사용자 이름, 이메일 등)

2.  **커밋 생성 (`tracker.commit`):**
    - **중첩된 Git 저장소 비활성화:** 가장 핵심적인 부분입니다. `git add .` 명령이 프로젝트 내의 다른 `.git` 폴더(예: 서브모듈)와 충돌하는 것을 막기 위해, 모든 중첩된 `.git` 폴더의 이름을 일시적으로 `_disabled` 접미사를 붙여 변경합니다.
    - **파일 추가:** `git add . -f --ignore-errors` 명령을 실행하여, 현재 작업 공간의 모든 변경 사항을 Shadow Git의 Staging Area에 추가합니다.
        - `-f` (force) 옵션: `.gitignore`에 의해 무시되는 파일(예: 테스트 중 생성되는 임시 파일)까지 강제로 추가하여, 작업 시점의 상태를 완벽하게 기록합니다.
    - **커밋:** 고유한 Task ID를 포함한 메시지로 커밋을 생성합니다.
    - **Git 저장소 복원:** 비활성화했던 모든 중첩된 `.git` 폴더의 이름을 원래대로 되돌립니다.

## 핵심 컴포넌트

- `CheckpointTracker.ts`: 체크포인트 생애주기를 관리하는 메인 컨트롤러입니다.
- `CheckpointGitOperations.ts`: `git` 명령어 실행, Shadow Git 초기화, 중첩된 저장소 이름 변경 등 실제 Git 관련 작업을 처리하는 클래스입니다.
- `CheckpointExclusions.ts`: 체크포인트에 포함하지 않을 파일 패턴(예: `node_modules`)을 정의합니다.

<Callout type="info">
	**디버깅 히스토리:** 이 시스템은 초기에 Caret 자신의 소스 코드 위에서 동작할 때, 자신의 `.git` 폴더를 처리하지 못해 멈추는
	버그가 있었습니다. 이 문제는 중첩된 `.git` 폴더를 임시로 비활성화하고, `.gitignore`에 의해 무시되는 파일까지 강제로 추가하는
	`-f` 옵션을 `git add`에 추가함으로써 해결되었습니다.
</Callout>
