# t08 - 페르소나 시스템 적용 분석 및 수정 계획

## 현재 상황 분석 (2025-09-05)

### 배경
- i18n 문제 해결 후 사용자가 페르소나 시스템의 전반적인 문제들을 공개
- caret-compare 프로젝트에 검증된 구현체가 존재
- 현재 프로젝트에서는 이미지 로딩만 파일 업로드 → Base64 변환이 성공적으로 작동 중

### 핵심 문제들 체크리스트

#### 1. 설정 저장 문제 ❌
- **문제**: enablePersonaSystem 토글 설정이 제대로 저장되지 않음
- **위치**: `CaretGeneralSettingsSection.tsx:44` - `setEnablePersonaSystem(checked)`
- **분석**: ExtensionStateContext에서 localStorage 처리가 제대로 되지 않을 수 있음
- **해결방법**: 설정 저장 로직 검증 필요

#### 2. gRPC 서비스 오류 ❌
- **문제**: `caret.PersonaService` 서비스를 찾을 수 없음
- **오류메시지**: gRPC service registration error
- **분석**: 백엔드에서 PersonaService가 제대로 등록되지 않음
- **해결방법**: gRPC 서비스 등록 확인 및 구현 필요

#### 3. 이미지 로딩 실패 ❌
- **문제**: 페르소나 이미지가 X-box로 표시됨 (로딩 실패)
- **문제**: 템플릿 모달 이미지들이 표시되지 않음
- **분석**: CSP (Content Security Policy) 문제 또는 경로 문제
- **해결방법**: caret-compare의 검증된 Base64 injection 방식 적용 필요

#### 4. UI 기능 문제 ❌
- **문제**: 페르소나 모달이 제대로 닫히지 않음
- **문제**: 잘못된 이미지 변경 (클릭 시 다른 이미지로 변경됨)
- **분석**: React 상태 관리 또는 이벤트 핸들링 문제
- **해결방법**: UI 상태 흐름 검증 및 수정 필요

### 아키텍처 분석

#### 기존 구조 (caret-merging)
- **CaretGlobalManager**: Auth0 통합된 싱글톤 패턴 (`caret-src/managers/CaretGlobalManager.ts`)
- **ExtensionStateContext**: React 상태 관리 (`webview-ui/src/context/ExtensionStateContext.tsx`)
- **설정 컴포넌트**: `CaretGeneralSettingsSection.tsx`

#### 검증된 구조 (caret-compare)  
- **CaretProviderWrapper**: webview 확장 패턴 (`caret-compare/caret-src/core/webview/CaretProviderWrapper.ts`)
- **이미지 injection**: Base64 window 변수 방식
- **성공적인 이미지 로딩**: file → Base64 → window.templateImage_* 패턴

---

## 🔍 **상세 분석 결과 (2025-09-05)**

### 1. 이미지 로딩 실패 원인 분석

#### **현재 방식 (실패)**:
```typescript
// convertAssetToImagePath() - Vite URL 방식 사용 (실패)
const convertAssetToImagePath = async (assetUri: string): Promise<string> => {
    if (assetUri.startsWith("asset://template_characters/")) {
        const fileName = assetUri.replace("asset://template_characters/", "")
        // Vite URL 변환 시도 - 런타임에서 실패
        const imageUrl = new URL(`../../../assets/template_characters/${fileName}`, import.meta.url).href
        return imageUrl
    }
}
```

#### **caret-compare 방식 (성공)**:
```typescript
// convertAssetToBase64() - Window 변수에서 Base64 직접 사용 (성공)
const convertAssetToBase64 = async (assetUri: string): Promise<string> => {
    if (assetUri.includes("caret.png")) {
        if ((window as any).templateImage_caret) {
            return (window as any).templateImage_caret // Base64 데이터 URI 반환
        }
    }
}
```

#### **핵심 차이점**:
- **현재**: Vite 번들링 환경에서 동적 경로 해석 실패
- **caret-compare**: CSP 호환, Base64 데이터 URI 직접 사용

### 2. 설정 저장 실패 원인 분석

#### **현재 방식 (실패)**:
```typescript
// ExtensionStateContext.tsx - localStorage만 저장, API 호출 누락
setEnablePersonaSystem: (enabled: boolean) => {
    setState(prev => ({ ...prev, enablePersonaSystem: enabled }))
    localStorage.setItem("caret-enablePersonaSystem", JSON.stringify(enabled))
    // ← StateServiceClient.updateSettings() 호출 없음!
}
```

#### **필요한 방식 (성공 패턴)**:
```typescript  
// 다른 설정들의 성공 패턴
setModeSystem: (modeSystem: CaretModeSystem) => {
    setState(prev => ({ ...prev, modeSystem }))
    StateServiceClient.updateSettings({ modeSystem }) // ← 이게 있어야 함
}
```

### 3. gRPC 서비스 등록 분석

#### **구성 요소 상태 확인**:
- ✅ **Proto 정의**: `proto/caret/persona.proto` 존재
- ✅ **핸들러**: `src/core/controller/persona/` 모든 핸들러 구현됨
- ✅ **타입 생성**: `src/shared/proto/caret/persona.ts` 정상 생성
- ✅ **ProtoBus 설정**: `scripts/generate-protobus-setup.mjs` caret 서비스 처리
- ✅ **서비스 등록**: `src/generated/hosts/vscode/protobus-services.ts` PersonaService 등록됨

#### **문제**: 런타임 서비스 등록/발견 실패
- VS Code Extension Host에서 실제 서비스가 등록되지 않음
- ProtoBus 클라이언트-서버 간 통신 실패

### 4. UI 기능 문제 분석

#### **현재 방식 (문제)**:
- 복잡한 gRPC 폴링: 500ms마다 PersonaService 호출
- 비동기 상태 충돌로 모달 닫기/이미지 변경 오작동

#### **caret-compare 방식 (안정)**:
- 단순한 상태 관리: 로컬 상태 + 필요시에만 API 호출
- 안정적인 이벤트 핸들링

---

## 📋 **수정 계획 (검증된 방식 적용)**

### **전략**: CaretProviderWrapper + 기존 패턴 통합

**사용자 요구사항**:
1. "가장 이상적인 구조, 확실한 결과(이미지)로 하는게 좋을것 같아"
2. "이미지 로딩 방식은 증명 된 방식을 썼으면 해"
3. "헷갈릴 것같다면 차라리 persona 관련한 모든것을 삭제후에 설계한대로 다시 이식하는 단계로 해"

### Phase 1: 기존 페르소나 시스템 정리 🧹
```bash
# 1. 기존 페르소나 컴포넌트 제거
rm -rf webview-ui/src/caret/components/PersonaManagement.tsx
rm -rf webview-ui/src/caret/components/PersonaTemplateSelector.tsx  
rm -rf webview-ui/src/caret/components/PersonaAvatar.tsx

# 2. 기존 페르소나 상태 관리 제거
# webview-ui/src/context/ExtensionStateContext.tsx에서 persona 관련 상태 제거

# 3. 기존 gRPC 클라이언트 제거
rm -rf webview-ui/src/caret/services/CaretGrpcClient.ts
rm -rf webview-ui/src/caret/context/CaretStateContext.tsx
```

### Phase 2: CaretProviderWrapper 기반 재구축 ✨

#### **2.1 백엔드 이미지 주입 시스템**
```typescript
// caret-src/core/webview/CaretProviderWrapper.ts (이미 완료)
export class CaretProviderWrapper implements vscode.WebviewViewProvider {
    async resolveWebviewView(webviewView: vscode.WebviewView) {
        // 1. Cline 핵심 초기화 완료
        await this.clineProvider.resolveWebviewView(webviewView)
        
        // 2. Base64 이미지 window 변수 주입
        await this.injectTemplateImagesAsBase64(webviewView)
    }
    
    private async injectTemplateImagesAsBase64(webviewView: vscode.WebviewView) {
        // assets/template_characters/*.png → window.templateImage_* 변수로 주입
        window.templateImage_caret = "data:image/png;base64,..."
        window.personaProfile = "data:image/png;base64,..."
        window.personaThinking = "data:image/png;base64,..."
    }
}
```

#### **2.2 프론트엔드 이미지 로딩**
```typescript
// webview-ui/src/caret/utils/convertAssetToBase64.ts (신규 생성)
export const convertAssetToBase64 = async (assetUri: string): Promise<string> => {
    if (!assetUri.startsWith("asset:")) return assetUri
    
    // CaretProviderWrapper에서 주입한 window 변수 확인
    if (assetUri.includes("caret.png") && (window as any).templateImage_caret) {
        return (window as any).templateImage_caret
    }
    
    // 안전한 fallback 플레이스홀더
    return "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQi..."
}
```

#### **2.3 설정 저장 시스템 통합**
```typescript
// webview-ui/src/context/ExtensionStateContext.tsx 수정
setEnablePersonaSystem: (enabled: boolean) => {
    // 1. CaretGlobalManager 업데이트 (t01 미션과 연계)
    CaretGlobalManager.get().setPersonaSystemEnabled(enabled)
    
    // 2. ExtensionState 업데이트  
    setState(prev => ({ ...prev, enablePersonaSystem: enabled }))
    
    // 3. 백엔드 저장 (다른 설정과 동일 패턴)
    StateServiceClient.updateSettings({ enablePersonaSystem: enabled })
}
```

#### **2.4 새로운 페르소나 컴포넌트 (caret-compare 기반)**
```typescript
// webview-ui/src/caret/components/PersonaAvatar.tsx (재구축)
const PersonaAvatar: React.FC = ({ personaProfile, isThinking }) => {
    const [avatarUrl, setAvatarUrl] = useState<string>("")
    
    useEffect(() => {
        const loadImage = async () => {
            const uri = isThinking ? personaProfile.thinking_avatar_uri : personaProfile.avatar_uri
            const base64 = await convertAssetToBase64(uri) // ← 검증된 방식
            setAvatarUrl(base64)
        }
        loadImage()
    }, [personaProfile, isThinking])
    
    return <img src={avatarUrl} className="w-16 h-16 rounded-full" />
}
```

### Phase 3: gRPC 서비스 디버깅 🔧
```bash
# 1. ProtoBus 재생성
npm run protos

# 2. 서비스 등록 확인
# VS Code Extension Host에서 실제 서비스 상태 확인
# ProtoBus 클라이언트-서버 통신 디버깅
```

### Phase 4: UI 통합 및 테스트 🎯
```typescript
// webview-ui/src/components/chat/ChatRow.tsx
// CARET MODIFICATION: PersonaAvatar 통합 (조건부 렌더링)
{enablePersonaSystem && modeSystem === "caret" && (
    <PersonaAvatar 
        personaProfile={personaProfile} 
        isThinking={message.type === "thinking"}
        size={64} 
    />
)}
```

---

## 🎯 **실행 우선순위**

### **1순위**: 이미지 로딩 (확실한 해결)
- CaretProviderWrapper Base64 injection 완료 ✅
- convertAssetToBase64 함수로 교체
- window 변수 직접 사용

### **2순위**: 설정 저장 (간단한 수정)  
- StateServiceClient.updateSettings() 호출 추가
- CaretGlobalManager 연동 (t01 미션과 통합)

### **3순위**: UI 재구축 (caret-compare 패턴)
- 기존 컴포넌트 삭제 후 재작성
- 단순한 상태 관리 적용

### **4순위**: gRPC 서비스 (디버깅 필요)
- Extension Host 서비스 등록 상태 확인
- ProtoBus 통신 디버깅

---

## 🚨 **완전 제거 및 이식 계획 (Final Plan)**

### **사용자 최종 지시사항**
1. "완전제거 하고 컴파일 되면 그 단계에서는 커밋 푸시 한번해"
2. "페르소나 선택 플래그에 따라 선택적 랜더링 만 하게 하면 되네"
3. "caret-compare를 그냥 이식이 결론"

### **Phase A: 완전 제거 계획 (🧹 Clean Slate)**

#### **A.1 제거 대상 파일 목록**
```bash
# 1. 페르소나 관련 컴포넌트 완전 삭제
webview-ui/src/caret/components/PersonaManagement.tsx
webview-ui/src/caret/components/PersonaTemplateSelector.tsx  
webview-ui/src/caret/components/PersonaAvatar.tsx

# 2. 페르소나 상태 관리 및 서비스 삭제
webview-ui/src/caret/services/CaretGrpcClient.ts
webview-ui/src/caret/context/CaretStateContext.tsx

# 3. 기존 페르소나 유틸리티 삭제 (중복/충돌 방지)
webview-ui/src/caret/utils/persona-utils.ts (있다면)
```

#### **A.2 파일 내 코드 제거 대상**
```typescript
// webview-ui/src/context/ExtensionStateContext.tsx
- enablePersonaSystem 관련 모든 상태
- PersonaProfile 관련 타입 임포트
- persona 관련 setter/getter 함수들

// webview-ui/src/components/settings/GeneralSettingsSection.tsx
- persona 시스템 토글 UI 코드 (일시 주석처리)

// webview-ui/src/components/chat/ChatRow.tsx
- PersonaAvatar 임포트 및 사용 코드 (일시 주석처리)
```

#### **A.3 컴파일 검증 포인트**
```bash
# TypeScript 컴파일 오류 해결
npm run compile

# 웹뷰 빌드 오류 해결
npm run build:webview

# 전체 빌드 성공 확인
npm run build
```

#### **A.4 중간 커밋 (제거 완료 시점)**
```bash
git add -A
git commit -m "feat: Remove existing persona system completely

- Delete PersonaManagement, PersonaTemplateSelector, PersonaAvatar components
- Delete CaretGrpcClient and CaretStateContext services  
- Remove persona state management from ExtensionStateContext
- Temporarily comment out persona UI in ChatRow and Settings
- Prepare for clean caret-compare persona system port

🤖 Generated with [Claude Code](https://claude.ai/code)"
git push
```

### **Phase B: caret-compare 이식 계획 (📦 Port)**

#### **B.1 caret-compare 분석 대상**
```bash
# 분석해야 할 caret-compare 디렉토리
caret-compare/caret-src/core/webview/CaretProviderWrapper.ts
caret-compare/webview-ui/src/caret/components/PersonaAvatar.tsx
caret-compare/webview-ui/src/caret/components/PersonaTemplateSelector.tsx
caret-compare/webview-ui/src/caret/components/PersonaManagement.tsx
caret-compare/webview-ui/src/caret/services/
caret-compare/webview-ui/src/caret/context/
```

#### **B.2 경로 변경 규칙**
```bash
# caret-compare → caret-merging 경로 변경
/assets/template_characters/  →  /assets/template_characters/
asset://assets/              →  asset:/assets/
```

#### **B.3 조건부 렌더링 통합**
```typescript
// 모든 페르소나 UI 컴포넌트에 적용할 패턴
{enablePersonaSystem && modeSystem === "caret" && (
    <PersonaComponents />
)}

// 적용 위치
- webview-ui/src/components/chat/ChatRow.tsx (아바타)
- webview-ui/src/components/settings/GeneralSettingsSection.tsx (설정)
- webview-ui/src/components/welcome/ (환영 페이지, 필요시)
```

#### **B.4 데이터 저장 방식**
**기존**: gRPC PersonaService → 복잡한 서비스 레이어
**새로운**: File-based → persona.md + agent_profile.png overwrite 방식
```typescript
// persona.md: LLM에 전달되는 글로벌 룰 (텍스트)  
// assets/agent_profile.png: 현재 선택된 페르소나 이미지 (오버라이트)
```

### **Phase C: UI 변경 범위 명세**

#### **C.1 ChatRow.tsx 변경**
```typescript
// BEFORE (주석처리)
// <div className="avatar-container">
//   <PersonaAvatar ... />  
// </div>

// AFTER (조건부 렌더링)
{enablePersonaSystem && modeSystem === "caret" && (
    <div className="avatar-container">
        <PersonaAvatar 
            personaProfile={currentPersona}
            isThinking={message.type === "thinking"}
            size={64} 
        />
    </div>
)}
```

#### **C.2 GeneralSettingsSection.tsx 변경**
```typescript
// BEFORE (주석처리)  
// <VSCodeCheckbox ...persona toggle... />

// AFTER (조건부 표시)
{modeSystem === "caret" && (
    <div className="persona-settings-section">
        <VSCodeCheckbox 
            checked={enablePersonaSystem}
            onChange={(e) => setEnablePersonaSystem(e.target.checked)}
        >
            Enable Persona System
        </VSCodeCheckbox>
        
        {enablePersonaSystem && (
            <PersonaManagementUI />
        )}
    </div>
)}
```

#### **C.3 새 컴포넌트 위치**
```bash
# caret-compare에서 이식할 컴포넌트들
webview-ui/src/caret/components/
├── PersonaAvatar.tsx           # 아바타 표시
├── PersonaManagement.tsx       # 관리 UI  
├── PersonaTemplateSelector.tsx # 템플릿 선택
├── PersonaUploader.tsx         # 이미지 업로드 (있다면)
└── index.ts                    # 배럴 export

webview-ui/src/caret/services/
└── persona-service.ts          # 파일 기반 서비스 (gRPC 대신)

webview-ui/src/caret/utils/
└── convertAssetToBase64.ts     # 검증된 이미지 로딩
```

### **Phase D: 검증 및 통합**

#### **D.1 기능 검증 체크리스트**
- [ ] 페르소나 이미지 로딩 성공 (Base64 방식)
- [ ] 템플릿 선택 기능 작동  
- [ ] 설정 저장/불러오기 정상 작동
- [ ] ChatRow에서 조건부 아바타 표시
- [ ] modeSystem="caret"일 때만 페르소나 기능 활성화

#### **D.2 최종 컴파일 및 테스트**
```bash
npm run compile      # TypeScript 컴파일 
npm run build:webview # 웹뷰 빌드
npm run test:backend  # 백엔드 테스트
npm run test:webview  # 프론트엔드 테스트 (있다면)
```

---

## 작업 상태

- **시작일**: 2025-09-05  
- **현재 상태**: ✅ **완전 제거 및 이식 계획 확정**
- **담당자**: Claude Code
- **전략**: Clean Slate → caret-compare 완전 이식 → 조건부 렌더링
- **우선순위**: 즉시 실행 (사용자 지시사항)