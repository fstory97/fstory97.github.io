# t08 - í˜ë¥´ì†Œë‚˜ ì‹œìŠ¤í…œ ì ìš© ë¶„ì„ ë° ìˆ˜ì • ê³„íš

## í˜„ì¬ ìƒí™© ë¶„ì„ (2025-09-05)

### ë°°ê²½
- i18n ë¬¸ì œ í•´ê²° í›„ ì‚¬ìš©ìê°€ í˜ë¥´ì†Œë‚˜ ì‹œìŠ¤í…œì˜ ì „ë°˜ì ì¸ ë¬¸ì œë“¤ì„ ê³µê°œ
- caret-compare í”„ë¡œì íŠ¸ì— ê²€ì¦ëœ êµ¬í˜„ì²´ê°€ ì¡´ì¬
- í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì´ë¯¸ì§€ ë¡œë”©ë§Œ íŒŒì¼ ì—…ë¡œë“œ â†’ Base64 ë³€í™˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ë™ ì¤‘

### í•µì‹¬ ë¬¸ì œë“¤ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### 1. ì„¤ì • ì €ì¥ ë¬¸ì œ âŒ
- **ë¬¸ì œ**: enablePersonaSystem í† ê¸€ ì„¤ì •ì´ ì œëŒ€ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŒ
- **ìœ„ì¹˜**: `CaretGeneralSettingsSection.tsx:44` - `setEnablePersonaSystem(checked)`
- **ë¶„ì„**: ExtensionStateContextì—ì„œ localStorage ì²˜ë¦¬ê°€ ì œëŒ€ë¡œ ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
- **í•´ê²°ë°©ë²•**: ì„¤ì • ì €ì¥ ë¡œì§ ê²€ì¦ í•„ìš”

#### 2. gRPC ì„œë¹„ìŠ¤ ì˜¤ë¥˜ âŒ
- **ë¬¸ì œ**: `caret.PersonaService` ì„œë¹„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
- **ì˜¤ë¥˜ë©”ì‹œì§€**: gRPC service registration error
- **ë¶„ì„**: ë°±ì—”ë“œì—ì„œ PersonaServiceê°€ ì œëŒ€ë¡œ ë“±ë¡ë˜ì§€ ì•ŠìŒ
- **í•´ê²°ë°©ë²•**: gRPC ì„œë¹„ìŠ¤ ë“±ë¡ í™•ì¸ ë° êµ¬í˜„ í•„ìš”

#### 3. ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ âŒ
- **ë¬¸ì œ**: í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ê°€ X-boxë¡œ í‘œì‹œë¨ (ë¡œë”© ì‹¤íŒ¨)
- **ë¬¸ì œ**: í…œí”Œë¦¿ ëª¨ë‹¬ ì´ë¯¸ì§€ë“¤ì´ í‘œì‹œë˜ì§€ ì•ŠìŒ
- **ë¶„ì„**: CSP (Content Security Policy) ë¬¸ì œ ë˜ëŠ” ê²½ë¡œ ë¬¸ì œ
- **í•´ê²°ë°©ë²•**: caret-compareì˜ ê²€ì¦ëœ Base64 injection ë°©ì‹ ì ìš© í•„ìš”

#### 4. UI ê¸°ëŠ¥ ë¬¸ì œ âŒ
- **ë¬¸ì œ**: í˜ë¥´ì†Œë‚˜ ëª¨ë‹¬ì´ ì œëŒ€ë¡œ ë‹«íˆì§€ ì•ŠìŒ
- **ë¬¸ì œ**: ì˜ëª»ëœ ì´ë¯¸ì§€ ë³€ê²½ (í´ë¦­ ì‹œ ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½ë¨)
- **ë¶„ì„**: React ìƒíƒœ ê´€ë¦¬ ë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ë§ ë¬¸ì œ
- **í•´ê²°ë°©ë²•**: UI ìƒíƒœ íë¦„ ê²€ì¦ ë° ìˆ˜ì • í•„ìš”

### ì•„í‚¤í…ì²˜ ë¶„ì„

#### ê¸°ì¡´ êµ¬ì¡° (caret-merging)
- **CaretGlobalManager**: Auth0 í†µí•©ëœ ì‹±ê¸€í†¤ íŒ¨í„´ (`caret-src/managers/CaretGlobalManager.ts`)
- **ExtensionStateContext**: React ìƒíƒœ ê´€ë¦¬ (`webview-ui/src/context/ExtensionStateContext.tsx`)
- **ì„¤ì • ì»´í¬ë„ŒíŠ¸**: `CaretGeneralSettingsSection.tsx`

#### ê²€ì¦ëœ êµ¬ì¡° (caret-compare)  
- **CaretProviderWrapper**: webview í™•ì¥ íŒ¨í„´ (`caret-compare/caret-src/core/webview/CaretProviderWrapper.ts`)
- **ì´ë¯¸ì§€ injection**: Base64 window ë³€ìˆ˜ ë°©ì‹
- **ì„±ê³µì ì¸ ì´ë¯¸ì§€ ë¡œë”©**: file â†’ Base64 â†’ window.templateImage_* íŒ¨í„´

---

## ğŸ” **ìƒì„¸ ë¶„ì„ ê²°ê³¼ (2025-09-05)**

### 1. ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ ì›ì¸ ë¶„ì„

#### **í˜„ì¬ ë°©ì‹ (ì‹¤íŒ¨)**:
```typescript
// convertAssetToImagePath() - Vite URL ë°©ì‹ ì‚¬ìš© (ì‹¤íŒ¨)
const convertAssetToImagePath = async (assetUri: string): Promise<string> => {
    if (assetUri.startsWith("asset://template_characters/")) {
        const fileName = assetUri.replace("asset://template_characters/", "")
        // Vite URL ë³€í™˜ ì‹œë„ - ëŸ°íƒ€ì„ì—ì„œ ì‹¤íŒ¨
        const imageUrl = new URL(`../../../assets/template_characters/${fileName}`, import.meta.url).href
        return imageUrl
    }
}
```

#### **caret-compare ë°©ì‹ (ì„±ê³µ)**:
```typescript
// convertAssetToBase64() - Window ë³€ìˆ˜ì—ì„œ Base64 ì§ì ‘ ì‚¬ìš© (ì„±ê³µ)
const convertAssetToBase64 = async (assetUri: string): Promise<string> => {
    if (assetUri.includes("caret.png")) {
        if ((window as any).templateImage_caret) {
            return (window as any).templateImage_caret // Base64 ë°ì´í„° URI ë°˜í™˜
        }
    }
}
```

#### **í•µì‹¬ ì°¨ì´ì **:
- **í˜„ì¬**: Vite ë²ˆë“¤ë§ í™˜ê²½ì—ì„œ ë™ì  ê²½ë¡œ í•´ì„ ì‹¤íŒ¨
- **caret-compare**: CSP í˜¸í™˜, Base64 ë°ì´í„° URI ì§ì ‘ ì‚¬ìš©

### 2. ì„¤ì • ì €ì¥ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„

#### **í˜„ì¬ ë°©ì‹ (ì‹¤íŒ¨)**:
```typescript
// ExtensionStateContext.tsx - localStorageë§Œ ì €ì¥, API í˜¸ì¶œ ëˆ„ë½
setEnablePersonaSystem: (enabled: boolean) => {
    setState(prev => ({ ...prev, enablePersonaSystem: enabled }))
    localStorage.setItem("caret-enablePersonaSystem", JSON.stringify(enabled))
    // â† StateServiceClient.updateSettings() í˜¸ì¶œ ì—†ìŒ!
}
```

#### **í•„ìš”í•œ ë°©ì‹ (ì„±ê³µ íŒ¨í„´)**:
```typescript  
// ë‹¤ë¥¸ ì„¤ì •ë“¤ì˜ ì„±ê³µ íŒ¨í„´
setModeSystem: (modeSystem: CaretModeSystem) => {
    setState(prev => ({ ...prev, modeSystem }))
    StateServiceClient.updateSettings({ modeSystem }) // â† ì´ê²Œ ìˆì–´ì•¼ í•¨
}
```

### 3. gRPC ì„œë¹„ìŠ¤ ë“±ë¡ ë¶„ì„

#### **êµ¬ì„± ìš”ì†Œ ìƒíƒœ í™•ì¸**:
- âœ… **Proto ì •ì˜**: `proto/caret/persona.proto` ì¡´ì¬
- âœ… **í•¸ë“¤ëŸ¬**: `src/core/controller/persona/` ëª¨ë“  í•¸ë“¤ëŸ¬ êµ¬í˜„ë¨
- âœ… **íƒ€ì… ìƒì„±**: `src/shared/proto/caret/persona.ts` ì •ìƒ ìƒì„±
- âœ… **ProtoBus ì„¤ì •**: `scripts/generate-protobus-setup.mjs` caret ì„œë¹„ìŠ¤ ì²˜ë¦¬
- âœ… **ì„œë¹„ìŠ¤ ë“±ë¡**: `src/generated/hosts/vscode/protobus-services.ts` PersonaService ë“±ë¡ë¨

#### **ë¬¸ì œ**: ëŸ°íƒ€ì„ ì„œë¹„ìŠ¤ ë“±ë¡/ë°œê²¬ ì‹¤íŒ¨
- VS Code Extension Hostì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ê°€ ë“±ë¡ë˜ì§€ ì•ŠìŒ
- ProtoBus í´ë¼ì´ì–¸íŠ¸-ì„œë²„ ê°„ í†µì‹  ì‹¤íŒ¨

### 4. UI ê¸°ëŠ¥ ë¬¸ì œ ë¶„ì„

#### **í˜„ì¬ ë°©ì‹ (ë¬¸ì œ)**:
- ë³µì¡í•œ gRPC í´ë§: 500msë§ˆë‹¤ PersonaService í˜¸ì¶œ
- ë¹„ë™ê¸° ìƒíƒœ ì¶©ëŒë¡œ ëª¨ë‹¬ ë‹«ê¸°/ì´ë¯¸ì§€ ë³€ê²½ ì˜¤ì‘ë™

#### **caret-compare ë°©ì‹ (ì•ˆì •)**:
- ë‹¨ìˆœí•œ ìƒíƒœ ê´€ë¦¬: ë¡œì»¬ ìƒíƒœ + í•„ìš”ì‹œì—ë§Œ API í˜¸ì¶œ
- ì•ˆì •ì ì¸ ì´ë²¤íŠ¸ í•¸ë“¤ë§

---

## ğŸ“‹ **ìˆ˜ì • ê³„íš (ê²€ì¦ëœ ë°©ì‹ ì ìš©)**

### **ì „ëµ**: CaretProviderWrapper + ê¸°ì¡´ íŒ¨í„´ í†µí•©

**ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­**:
1. "ê°€ì¥ ì´ìƒì ì¸ êµ¬ì¡°, í™•ì‹¤í•œ ê²°ê³¼(ì´ë¯¸ì§€)ë¡œ í•˜ëŠ”ê²Œ ì¢‹ì„ê²ƒ ê°™ì•„"
2. "ì´ë¯¸ì§€ ë¡œë”© ë°©ì‹ì€ ì¦ëª… ëœ ë°©ì‹ì„ ì¼ìœ¼ë©´ í•´"
3. "í—·ê°ˆë¦´ ê²ƒê°™ë‹¤ë©´ ì°¨ë¼ë¦¬ persona ê´€ë ¨í•œ ëª¨ë“ ê²ƒì„ ì‚­ì œí›„ì— ì„¤ê³„í•œëŒ€ë¡œ ë‹¤ì‹œ ì´ì‹í•˜ëŠ” ë‹¨ê³„ë¡œ í•´"

### Phase 1: ê¸°ì¡´ í˜ë¥´ì†Œë‚˜ ì‹œìŠ¤í…œ ì •ë¦¬ ğŸ§¹
```bash
# 1. ê¸°ì¡´ í˜ë¥´ì†Œë‚˜ ì»´í¬ë„ŒíŠ¸ ì œê±°
rm -rf webview-ui/src/caret/components/PersonaManagement.tsx
rm -rf webview-ui/src/caret/components/PersonaTemplateSelector.tsx  
rm -rf webview-ui/src/caret/components/PersonaAvatar.tsx

# 2. ê¸°ì¡´ í˜ë¥´ì†Œë‚˜ ìƒíƒœ ê´€ë¦¬ ì œê±°
# webview-ui/src/context/ExtensionStateContext.tsxì—ì„œ persona ê´€ë ¨ ìƒíƒœ ì œê±°

# 3. ê¸°ì¡´ gRPC í´ë¼ì´ì–¸íŠ¸ ì œê±°
rm -rf webview-ui/src/caret/services/CaretGrpcClient.ts
rm -rf webview-ui/src/caret/context/CaretStateContext.tsx
```

### Phase 2: CaretProviderWrapper ê¸°ë°˜ ì¬êµ¬ì¶• âœ¨

#### **2.1 ë°±ì—”ë“œ ì´ë¯¸ì§€ ì£¼ì… ì‹œìŠ¤í…œ**
```typescript
// caret-src/core/webview/CaretProviderWrapper.ts (ì´ë¯¸ ì™„ë£Œ)
export class CaretProviderWrapper implements vscode.WebviewViewProvider {
    async resolveWebviewView(webviewView: vscode.WebviewView) {
        // 1. Cline í•µì‹¬ ì´ˆê¸°í™” ì™„ë£Œ
        await this.clineProvider.resolveWebviewView(webviewView)
        
        // 2. Base64 ì´ë¯¸ì§€ window ë³€ìˆ˜ ì£¼ì…
        await this.injectTemplateImagesAsBase64(webviewView)
    }
    
    private async injectTemplateImagesAsBase64(webviewView: vscode.WebviewView) {
        // assets/template_characters/*.png â†’ window.templateImage_* ë³€ìˆ˜ë¡œ ì£¼ì…
        window.templateImage_caret = "data:image/png;base64,..."
        window.personaProfile = "data:image/png;base64,..."
        window.personaThinking = "data:image/png;base64,..."
    }
}
```

#### **2.2 í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¡œë”©**
```typescript
// webview-ui/src/caret/utils/convertAssetToBase64.ts (ì‹ ê·œ ìƒì„±)
export const convertAssetToBase64 = async (assetUri: string): Promise<string> => {
    if (!assetUri.startsWith("asset:")) return assetUri
    
    // CaretProviderWrapperì—ì„œ ì£¼ì…í•œ window ë³€ìˆ˜ í™•ì¸
    if (assetUri.includes("caret.png") && (window as any).templateImage_caret) {
        return (window as any).templateImage_caret
    }
    
    // ì•ˆì „í•œ fallback í”Œë ˆì´ìŠ¤í™€ë”
    return "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQi..."
}
```

#### **2.3 ì„¤ì • ì €ì¥ ì‹œìŠ¤í…œ í†µí•©**
```typescript
// webview-ui/src/context/ExtensionStateContext.tsx ìˆ˜ì •
setEnablePersonaSystem: (enabled: boolean) => {
    // 1. CaretGlobalManager ì—…ë°ì´íŠ¸ (t01 ë¯¸ì…˜ê³¼ ì—°ê³„)
    CaretGlobalManager.get().setPersonaSystemEnabled(enabled)
    
    // 2. ExtensionState ì—…ë°ì´íŠ¸  
    setState(prev => ({ ...prev, enablePersonaSystem: enabled }))
    
    // 3. ë°±ì—”ë“œ ì €ì¥ (ë‹¤ë¥¸ ì„¤ì •ê³¼ ë™ì¼ íŒ¨í„´)
    StateServiceClient.updateSettings({ enablePersonaSystem: enabled })
}
```

#### **2.4 ìƒˆë¡œìš´ í˜ë¥´ì†Œë‚˜ ì»´í¬ë„ŒíŠ¸ (caret-compare ê¸°ë°˜)**
```typescript
// webview-ui/src/caret/components/PersonaAvatar.tsx (ì¬êµ¬ì¶•)
const PersonaAvatar: React.FC = ({ personaProfile, isThinking }) => {
    const [avatarUrl, setAvatarUrl] = useState<string>("")
    
    useEffect(() => {
        const loadImage = async () => {
            const uri = isThinking ? personaProfile.thinking_avatar_uri : personaProfile.avatar_uri
            const base64 = await convertAssetToBase64(uri) // â† ê²€ì¦ëœ ë°©ì‹
            setAvatarUrl(base64)
        }
        loadImage()
    }, [personaProfile, isThinking])
    
    return <img src={avatarUrl} className="w-16 h-16 rounded-full" />
}
```

### Phase 3: gRPC ì„œë¹„ìŠ¤ ë””ë²„ê¹… ğŸ”§
```bash
# 1. ProtoBus ì¬ìƒì„±
npm run protos

# 2. ì„œë¹„ìŠ¤ ë“±ë¡ í™•ì¸
# VS Code Extension Hostì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
# ProtoBus í´ë¼ì´ì–¸íŠ¸-ì„œë²„ í†µì‹  ë””ë²„ê¹…
```

### Phase 4: UI í†µí•© ë° í…ŒìŠ¤íŠ¸ ğŸ¯
```typescript
// webview-ui/src/components/chat/ChatRow.tsx
// CARET MODIFICATION: PersonaAvatar í†µí•© (ì¡°ê±´ë¶€ ë Œë”ë§)
{enablePersonaSystem && modeSystem === "caret" && (
    <PersonaAvatar 
        personaProfile={personaProfile} 
        isThinking={message.type === "thinking"}
        size={64} 
    />
)}
```

---

## ğŸ¯ **ì‹¤í–‰ ìš°ì„ ìˆœìœ„**

### **1ìˆœìœ„**: ì´ë¯¸ì§€ ë¡œë”© (í™•ì‹¤í•œ í•´ê²°)
- CaretProviderWrapper Base64 injection ì™„ë£Œ âœ…
- convertAssetToBase64 í•¨ìˆ˜ë¡œ êµì²´
- window ë³€ìˆ˜ ì§ì ‘ ì‚¬ìš©

### **2ìˆœìœ„**: ì„¤ì • ì €ì¥ (ê°„ë‹¨í•œ ìˆ˜ì •)  
- StateServiceClient.updateSettings() í˜¸ì¶œ ì¶”ê°€
- CaretGlobalManager ì—°ë™ (t01 ë¯¸ì…˜ê³¼ í†µí•©)

### **3ìˆœìœ„**: UI ì¬êµ¬ì¶• (caret-compare íŒ¨í„´)
- ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ ì‚­ì œ í›„ ì¬ì‘ì„±
- ë‹¨ìˆœí•œ ìƒíƒœ ê´€ë¦¬ ì ìš©

### **4ìˆœìœ„**: gRPC ì„œë¹„ìŠ¤ (ë””ë²„ê¹… í•„ìš”)
- Extension Host ì„œë¹„ìŠ¤ ë“±ë¡ ìƒíƒœ í™•ì¸
- ProtoBus í†µì‹  ë””ë²„ê¹…

---

## ğŸš¨ **ì™„ì „ ì œê±° ë° ì´ì‹ ê³„íš (Final Plan)**

### **ì‚¬ìš©ì ìµœì¢… ì§€ì‹œì‚¬í•­**
1. "ì™„ì „ì œê±° í•˜ê³  ì»´íŒŒì¼ ë˜ë©´ ê·¸ ë‹¨ê³„ì—ì„œëŠ” ì»¤ë°‹ í‘¸ì‹œ í•œë²ˆí•´"
2. "í˜ë¥´ì†Œë‚˜ ì„ íƒ í”Œë˜ê·¸ì— ë”°ë¼ ì„ íƒì  ëœë”ë§ ë§Œ í•˜ê²Œ í•˜ë©´ ë˜ë„¤"
3. "caret-compareë¥¼ ê·¸ëƒ¥ ì´ì‹ì´ ê²°ë¡ "

### **Phase A: ì™„ì „ ì œê±° ê³„íš (ğŸ§¹ Clean Slate)**

#### **A.1 ì œê±° ëŒ€ìƒ íŒŒì¼ ëª©ë¡**
```bash
# 1. í˜ë¥´ì†Œë‚˜ ê´€ë ¨ ì»´í¬ë„ŒíŠ¸ ì™„ì „ ì‚­ì œ
webview-ui/src/caret/components/PersonaManagement.tsx
webview-ui/src/caret/components/PersonaTemplateSelector.tsx  
webview-ui/src/caret/components/PersonaAvatar.tsx

# 2. í˜ë¥´ì†Œë‚˜ ìƒíƒœ ê´€ë¦¬ ë° ì„œë¹„ìŠ¤ ì‚­ì œ
webview-ui/src/caret/services/CaretGrpcClient.ts
webview-ui/src/caret/context/CaretStateContext.tsx

# 3. ê¸°ì¡´ í˜ë¥´ì†Œë‚˜ ìœ í‹¸ë¦¬í‹° ì‚­ì œ (ì¤‘ë³µ/ì¶©ëŒ ë°©ì§€)
webview-ui/src/caret/utils/persona-utils.ts (ìˆë‹¤ë©´)
```

#### **A.2 íŒŒì¼ ë‚´ ì½”ë“œ ì œê±° ëŒ€ìƒ**
```typescript
// webview-ui/src/context/ExtensionStateContext.tsx
- enablePersonaSystem ê´€ë ¨ ëª¨ë“  ìƒíƒœ
- PersonaProfile ê´€ë ¨ íƒ€ì… ì„í¬íŠ¸
- persona ê´€ë ¨ setter/getter í•¨ìˆ˜ë“¤

// webview-ui/src/components/settings/GeneralSettingsSection.tsx
- persona ì‹œìŠ¤í…œ í† ê¸€ UI ì½”ë“œ (ì¼ì‹œ ì£¼ì„ì²˜ë¦¬)

// webview-ui/src/components/chat/ChatRow.tsx
- PersonaAvatar ì„í¬íŠ¸ ë° ì‚¬ìš© ì½”ë“œ (ì¼ì‹œ ì£¼ì„ì²˜ë¦¬)
```

#### **A.3 ì»´íŒŒì¼ ê²€ì¦ í¬ì¸íŠ¸**
```bash
# TypeScript ì»´íŒŒì¼ ì˜¤ë¥˜ í•´ê²°
npm run compile

# ì›¹ë·° ë¹Œë“œ ì˜¤ë¥˜ í•´ê²°
npm run build:webview

# ì „ì²´ ë¹Œë“œ ì„±ê³µ í™•ì¸
npm run build
```

#### **A.4 ì¤‘ê°„ ì»¤ë°‹ (ì œê±° ì™„ë£Œ ì‹œì )**
```bash
git add -A
git commit -m "feat: Remove existing persona system completely

- Delete PersonaManagement, PersonaTemplateSelector, PersonaAvatar components
- Delete CaretGrpcClient and CaretStateContext services  
- Remove persona state management from ExtensionStateContext
- Temporarily comment out persona UI in ChatRow and Settings
- Prepare for clean caret-compare persona system port

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)"
git push
```

### **Phase B: caret-compare ì´ì‹ ê³„íš (ğŸ“¦ Port)**

#### **B.1 caret-compare ë¶„ì„ ëŒ€ìƒ**
```bash
# ë¶„ì„í•´ì•¼ í•  caret-compare ë””ë ‰í† ë¦¬
caret-compare/caret-src/core/webview/CaretProviderWrapper.ts
caret-compare/webview-ui/src/caret/components/PersonaAvatar.tsx
caret-compare/webview-ui/src/caret/components/PersonaTemplateSelector.tsx
caret-compare/webview-ui/src/caret/components/PersonaManagement.tsx
caret-compare/webview-ui/src/caret/services/
caret-compare/webview-ui/src/caret/context/
```

#### **B.2 ê²½ë¡œ ë³€ê²½ ê·œì¹™**
```bash
# caret-compare â†’ caret-merging ê²½ë¡œ ë³€ê²½
/assets/template_characters/  â†’  /assets/template_characters/
asset://assets/              â†’  asset:/assets/
```

#### **B.3 ì¡°ê±´ë¶€ ë Œë”ë§ í†µí•©**
```typescript
// ëª¨ë“  í˜ë¥´ì†Œë‚˜ UI ì»´í¬ë„ŒíŠ¸ì— ì ìš©í•  íŒ¨í„´
{enablePersonaSystem && modeSystem === "caret" && (
    <PersonaComponents />
)}

// ì ìš© ìœ„ì¹˜
- webview-ui/src/components/chat/ChatRow.tsx (ì•„ë°”íƒ€)
- webview-ui/src/components/settings/GeneralSettingsSection.tsx (ì„¤ì •)
- webview-ui/src/components/welcome/ (í™˜ì˜ í˜ì´ì§€, í•„ìš”ì‹œ)
```

#### **B.4 ë°ì´í„° ì €ì¥ ë°©ì‹**
**ê¸°ì¡´**: gRPC PersonaService â†’ ë³µì¡í•œ ì„œë¹„ìŠ¤ ë ˆì´ì–´
**ìƒˆë¡œìš´**: File-based â†’ persona.md + agent_profile.png overwrite ë°©ì‹
```typescript
// persona.md: LLMì— ì „ë‹¬ë˜ëŠ” ê¸€ë¡œë²Œ ë£° (í…ìŠ¤íŠ¸)  
// assets/agent_profile.png: í˜„ì¬ ì„ íƒëœ í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ (ì˜¤ë²„ë¼ì´íŠ¸)
```

### **Phase C: UI ë³€ê²½ ë²”ìœ„ ëª…ì„¸**

#### **C.1 ChatRow.tsx ë³€ê²½**
```typescript
// BEFORE (ì£¼ì„ì²˜ë¦¬)
// <div className="avatar-container">
//   <PersonaAvatar ... />  
// </div>

// AFTER (ì¡°ê±´ë¶€ ë Œë”ë§)
{enablePersonaSystem && modeSystem === "caret" && (
    <div className="avatar-container">
        <PersonaAvatar 
            personaProfile={currentPersona}
            isThinking={message.type === "thinking"}
            size={64} 
        />
    </div>
)}
```

#### **C.2 GeneralSettingsSection.tsx ë³€ê²½**
```typescript
// BEFORE (ì£¼ì„ì²˜ë¦¬)  
// <VSCodeCheckbox ...persona toggle... />

// AFTER (ì¡°ê±´ë¶€ í‘œì‹œ)
{modeSystem === "caret" && (
    <div className="persona-settings-section">
        <VSCodeCheckbox 
            checked={enablePersonaSystem}
            onChange={(e) => setEnablePersonaSystem(e.target.checked)}
        >
            Enable Persona System
        </VSCodeCheckbox>
        
        {enablePersonaSystem && (
            <PersonaManagementUI />
        )}
    </div>
)}
```

#### **C.3 ìƒˆ ì»´í¬ë„ŒíŠ¸ ìœ„ì¹˜**
```bash
# caret-compareì—ì„œ ì´ì‹í•  ì»´í¬ë„ŒíŠ¸ë“¤
webview-ui/src/caret/components/
â”œâ”€â”€ PersonaAvatar.tsx           # ì•„ë°”íƒ€ í‘œì‹œ
â”œâ”€â”€ PersonaManagement.tsx       # ê´€ë¦¬ UI  
â”œâ”€â”€ PersonaTemplateSelector.tsx # í…œí”Œë¦¿ ì„ íƒ
â”œâ”€â”€ PersonaUploader.tsx         # ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìˆë‹¤ë©´)
â””â”€â”€ index.ts                    # ë°°ëŸ´ export

webview-ui/src/caret/services/
â””â”€â”€ persona-service.ts          # íŒŒì¼ ê¸°ë°˜ ì„œë¹„ìŠ¤ (gRPC ëŒ€ì‹ )

webview-ui/src/caret/utils/
â””â”€â”€ convertAssetToBase64.ts     # ê²€ì¦ëœ ì´ë¯¸ì§€ ë¡œë”©
```

### **Phase D: ê²€ì¦ ë° í†µí•©**

#### **D.1 ê¸°ëŠ¥ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸**
- [ ] í˜ë¥´ì†Œë‚˜ ì´ë¯¸ì§€ ë¡œë”© ì„±ê³µ (Base64 ë°©ì‹)
- [ ] í…œí”Œë¦¿ ì„ íƒ ê¸°ëŠ¥ ì‘ë™  
- [ ] ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ì •ìƒ ì‘ë™
- [ ] ChatRowì—ì„œ ì¡°ê±´ë¶€ ì•„ë°”íƒ€ í‘œì‹œ
- [ ] modeSystem="caret"ì¼ ë•Œë§Œ í˜ë¥´ì†Œë‚˜ ê¸°ëŠ¥ í™œì„±í™”

#### **D.2 ìµœì¢… ì»´íŒŒì¼ ë° í…ŒìŠ¤íŠ¸**
```bash
npm run compile      # TypeScript ì»´íŒŒì¼ 
npm run build:webview # ì›¹ë·° ë¹Œë“œ
npm run test:backend  # ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
npm run test:webview  # í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ (ìˆë‹¤ë©´)
```

---

## ì‘ì—… ìƒíƒœ

- **ì‹œì‘ì¼**: 2025-09-05  
- **í˜„ì¬ ìƒíƒœ**: âœ… **ì™„ì „ ì œê±° ë° ì´ì‹ ê³„íš í™•ì •**
- **ë‹´ë‹¹ì**: Claude Code
- **ì „ëµ**: Clean Slate â†’ caret-compare ì™„ì „ ì´ì‹ â†’ ì¡°ê±´ë¶€ ë Œë”ë§
- **ìš°ì„ ìˆœìœ„**: ì¦‰ì‹œ ì‹¤í–‰ (ì‚¬ìš©ì ì§€ì‹œì‚¬í•­)