# f08 - Chatbot/Agent 모드 시스템 머징 작업

## 기능 개요
- **목적**: Cline Plan/Act 모드를 완전히 새로운 방식으로 재해석한 독립적 AI 상호작용 시스템
- **현재 상태**: ✅ 완전 구현 완료 (Level 1 독립 모듈 달성)
- **우선순위**: HIGH - 사용자 경험 혁신 및 차별화 핵심

## 주요 구성 요소

### Plan/Act vs Chatbot/Agent 차이점

| 구분            | Cline Plan/Act               | Caret Chatbot/Agent              |
| --------------- | ---------------------------- | -------------------------------- |
| **경험 방식**   | 분절된 경험 (계획→승인→실행) | 단일 연속 경험 (자연스러운 대화) |
| **AI 역할**     | 도구 사용 중심               | 대화와 협업 중심                 |
| **사용자 관점** | 기술적 용어 (Plan/Act)       | 직관적 용어 (Chatbot/Agent)      |

### AI 행동 패턴

#### 🤖 Chatbot Mode (상담사 역할)
- **AI 태도**: "이 방법은 어떠신가요?", "더 궁금한 점이 있으신가요?"
- **주도권**: 개발자가 주도, AI는 조언과 분석만 제공
- **안전성**: 위험한 작업(파일 수정, 명령 실행) 차단
- **용도**: 코드 리뷰, 기술 상담, 아키텍처 조언

#### ⚡ Agent Mode (협력 파트너 역할)
- **AI 태도**: "이 작업을 진행하겠습니다", "다음 단계로 넘어갑니다"
- **주도권**: AI가 주도, 모든 개발 작업 직접 수행
- **자유도**: 모든 도구 사용 + 자유로운 대화 가능
- **용도**: 기능 구현, 버그 수정, 자동화 작업

## 차별화 포인트
- **완전 독립성**: Plan/Act 코드와 0% 의존성
- **어댑터 패턴**: Cline 인프라 재사용하되 완전히 다르게 해석
- **이중 보안**: JSON 프롬프트 + 실행시점 차단으로 Chatbot 모드 안전성 보장
- **Factory 패턴**: Caret/Cline 시스템 완전 분리

## 머징 계획 

### Phase 1: TDD 테스트 환경 구축
- [ ] 어댑터 패턴 테스트 이식
  ```bash
  cp -r caret-main/caret-src/core/mode-system/__tests__ \
        caret-src/core/mode-system/__tests__
  ```
- [ ] 테스트 실행 확인
  ```bash
  npm run test:backend -- mode-system
  ```

### Phase 2: 어댑터 패턴 시스템 이식
- [ ] ModeSystemRegistry 이식
  ```bash
  cp caret-main/caret-src/core/mode-system/ModeSystemRegistry.ts \
     caret-src/core/mode-system/
  ```
- [ ] 상수 시스템 이식
  ```bash
  cp caret-main/caret-src/shared/constants/ModeSystemConstants.ts \
     caret-src/shared/constants/
  ```

### Phase 3: JSON 프롬프트 시스템 이식 (f07 통합)
- [ ] JSON 섹션 어셈블러 이식
  ```bash
  cp -r caret-main/caret-src/core/prompts/ \
        caret-src/core/prompts/
  ```
- [ ] 18개 JSON 섹션 이식 (f07과 공통)

### Phase 4: 도구 제한 시스템 이식
- [ ] 도구 핸들러 이식
  ```bash
  cp caret-main/caret-src/core/tools/CaretToolHandler.ts \
     caret-src/core/tools/
  
  cp caret-main/caret-src/core/tools/CaretToolSelector.ts \
     caret-src/core/tools/
  ```

### Phase 5: Factory 패턴 메시징 시스템 이식
- [ ] 메시지 핸들러 팩토리 이식
  ```bash
  cp -r caret-main/caret-src/core/messaging/ \
        caret-src/core/messaging/
  ```

### Phase 6: 백엔드 통합 (최소 수정)
- [ ] build-system-prompt.ts 분기 로직 추가 (4라인)
  ```typescript
  // CARET MODIFICATION: modeSystem 기반 프롬프트 분기
  if (modeSystem === "caret") {
      return await modeRegistry.buildSystemPrompt(modeSystem, mode, context)
  }
  ```
- [ ] task/index.ts에 환경 세부사항 추가 (1개 메서드)
- [ ] ToolExecutor.ts에 도구 제한 검사 추가 (5라인)

### Phase 7: 프론트엔드 UI 통합
- [ ] 모드 시스템 설정 UI 이식
  ```bash
  cp caret-main/webview-ui/src/caret/components/CaretModeSystemSetting.tsx \
     webview-ui/src/caret/components/
  ```
- [ ] ChatTextArea.tsx 라벨 변경 (2개 수정)
- [ ] buttonConfig.ts Factory 패턴 적용 (2줄 핵심 수정)

### Phase 8: Proto 시스템 확장
- [ ] state.proto에 modeSystem 필드 추가
- [ ] 변환 로직 이식
  ```bash
  cp caret-main/caret-src/shared/proto-conversions/state/caret-settings-conversion.ts \
     caret-src/shared/proto-conversions/state/
  ```

### Phase 9: 통합 테스트
- [ ] 42개 통합 테스트 실행
- [ ] 37개 TDD 테스트 실행
- [ ] End-to-End 테스트
- [ ] UI 호환성 테스트

## 핵심 아키텍처: 어댑터 패턴

### ModeSystemRegistry (중앙 집중화)
```typescript
// 목표: 어댑터 패턴으로 완전 분리된 시스템
interface ModeSystemAdapter {
    // 환경 및 프롬프트
    getEnvironmentDetails(mode: string): string
    buildSystemPrompt(mode: string, context: any): Promise<string>
    
    // 도구 처리
    getResponseToolName(mode: string): string
    handleToolResponse(toolName: string, params: any): Promise<any>
    
    // UI 표현
    getModeDisplayName(mode: string): string
    getToggleTarget(currentMode: string): string
}

// 중앙 레지스트리 (싱글톤 패턴)
class ModeSystemRegistry {
    private adapters = new Map<string, ModeSystemAdapter>()
    
    getEnvironmentDetails(modeSystem: string, mode: string): string {
        return this.getAdapter(modeSystem).getEnvironmentDetails(mode)
    }
    
    async buildSystemPrompt(modeSystem: string, mode: string, context: any): Promise<string> {
        return this.getAdapter(modeSystem).buildSystemPrompt(mode, context)
    }
}
```

### Caret 시스템 어댑터 (독립적 구현)
```typescript
class CaretModeAdapter implements ModeSystemAdapter {
    getEnvironmentDetails(mode: string): string {
        return mode === "plan"
            ? "\nCHATBOT MODE\nExpert consultation..."
            : "\nAGENT MODE\nCollaborative development..."
    }
    
    async buildSystemPrompt(mode: string, context: any): Promise<string> {
        // JSON 기반 Caret 전용 프롬프트 생성 (f07 통합)
        const assembler = new JsonSectionAssembler(context.templateLoader)
        return assembler.assembleFinalPrompt(await assembler.loadBaseSections(mode))
    }
}
```

## 이중 보안 레이어 (Chatbot 모드 안전성)

### Layer 1: JSON 기반 프롬프트 필터링
```json
// caret-src/core/prompts/sections/TOOL_DEFINITIONS.json
{
    "execute_command": {
        "mode_restriction": "agent_only"
    },
    "write_to_file": {
        "mode_restriction": "agent_only"
    },
    "replace_in_file": {
        "mode_restriction": "agent_only"
    }
}
```

### Layer 2: 실행시점 상수 기반 차단
```typescript
// caret-src/shared/constants/ModeSystemConstants.ts
export const RESTRICTED_TOOLS = {
    CHATBOT_BLOCKED: ["write_to_file", "replace_in_file", "execute_command"] as const,
    AGENT_ALLOWED: "*" as const,
} as const
```

## Factory 패턴 메시징 시스템

### MessageHandlerFactory (완전 분리)
```typescript
export class MessageHandlerFactory {
    static create(modeSystem: "caret" | "cline"): MessageHandlerInterface {
        return modeSystem === "caret"
            ? new CaretMessageHandler() // 순수 Caret 로직만
            : new ClineMessageHandler() // 순수 Cline 로직만
    }
}

// Caret 전용 핸들러 (Optimistic Update 포함)
class CaretMessageHandler implements MessageHandlerInterface {
    async handleSendMessage(text: string, images: string[], files: string[], clineAsk?: string, messagesLength?: number) {
        // Optimistic UI Update 구현 완료
        this.addOptimisticUserMessage(text)
        
        // Caret 전용: 자유로운 대화, Agent 모드 지원
        if (this.isNewConversation(messagesLength)) {
            return TaskServiceClient.newTask({ text, images, files })
        } else {
            return TaskServiceClient.askResponse({
                responseType: "messageResponse",
                text,
                images,
                files,
            })
        }
    }
}
```

## 실제 구현된 파일 구조

```
프로젝트 루트/
├── src/ (Cline 최소 수정 - 5개 핵심 파일만)
│   ├── core/task/
│   │   └── ToolExecutor.ts                       # 이중 보안: isCaretToolRestricted() 메서드 (5라인)
│   ├── core/prompts/system-prompt/
│   │   └── build-system-prompt.ts                # modeRegistry 분기 로직 (4라인)
│   └── core/controller/state/
│       └── updateSettings.ts                     # CaretSettings 처리 (4라인)

├── caret-src/ (Caret 완전 독립 시스템)
│   ├── shared/
│   │   ├── CaretSettings.ts                      # 독립적인 설정 타입
│   │   ├── constants/
│   │   │   └── ModeSystemConstants.ts            # 모든 하드코딩 문자열 상수화
│   │   └── proto-conversions/state/
│   │       └── caret-settings-conversion.ts      # Caret↔Cline 변환 로직
│   │
│   ├── core/
│   │   ├── mode-system/                          # 어댑터 패턴 시스템
│   │   │   ├── ModeSystemRegistry.ts             # 중앙 집중식 모드 관리
│   │   │   └── __tests__/                        # 42개 통합 테스트
│   │   │
│   │   ├── prompts/                              # JSON 프롬프트 시스템 (f07 통합)
│   │   │   ├── JsonSectionAssembler.ts           # JSON 기반 프롬프트 조립
│   │   │   ├── JsonTemplateLoader.ts             # 템플릿 로딩 시스템
│   │   │   ├── CaretSystemPrompt.ts              # 독립적 시스템 프롬프트
│   │   │   └── sections/                         # 18개 JSON 섹션
│   │   │
│   │   ├── messaging/                            # Factory 패턴 메시징
│   │   │   ├── MessageHandlerFactory.ts          # 팩토리 진입점
│   │   │   ├── CaretMessageHandler.ts            # Caret 전용 로직
│   │   │   ├── ButtonConfigFactory.ts            # 버튼 설정 팩토리
│   │   │   ├── CaretButtonConfigHandler.ts       # Caret 버튼 로직
│   │   │   └── interfaces/
│   │   │       └── MessageHandlerInterface.ts    # 공통 인터페이스
│   │   │
│   │   └── tools/                                # JSON 기반 도구 시스템
│   │       ├── CaretToolHandler.ts               # 도구 필터링 로직
│   │       ├── CaretToolSelector.ts              # 지능형 도구 선택
│   │       └── __tests__/                        # 12개 도구 테스트
│   │
│   └── __tests__/                                # 종합 검증 시스템
│       ├── integration/                          # End-to-End 테스트
│       └── tdd/                                  # TDD 테스트

└── webview-ui/src/ (프론트엔드 - Caret 확장)
    ├── components/chat/
    │   ├── ChatTextArea.tsx                      # modeSystem 기반 라벨 변경 (2개 수정)
    │   ├── ChatRow.tsx                           # chatbot_mode_respond UI 처리 (5개 수정)
    │   └── chat-view/
    │       ├── hooks/
    │       │   └── useMessageHandlers.ts         # Factory 패턴 적용 (1줄만 수정)
    │       └── shared/
    │           ├── buttonConfig.ts               # Agent 대화 흐름 완성 (2줄 핵심 수정)
    │           └── __tests__/                    # 대화 흐름 검증 테스트
    └── caret/
        └── components/
            └── CaretModeSystemSetting.tsx        # 모드 시스템 토글 UI (9개 수정)
```

## 사용자 경험

### 모드 전환
1. **단축키로 빠른 전환**: `⌘⇧A` (macOS) 또는 `Ctrl+Shift+A` (Windows/Linux)
2. **UI에서 수동 전환**: 채팅 입력창 상단의 모드 토글 버튼 클릭
3. **시스템 모드 선택**: 설정에서 Caret 모드 ↔ Cline 모드 전환 가능

### 대화 흐름
- **자유 대화**: AI 응답 완료 후 추가 질문이나 요청 가능
- **연속 대화**: 이전 대화 맥락을 유지하면서 지속적인 상호작용
- **모드 전환**: 대화 중에도 필요에 따라 모드 변경 가능

### 최적 사용 시나리오

#### 🤖 Chatbot Mode 활용
- 코드 분석 및 리뷰
- 아키텍처 설계 상담
- 기술 선택 조언
- 디버깅 분석
- 학습 및 교육

#### ⚡ Agent Mode 활용
- 기능 구현 및 개발
- 프로젝트 설정 및 초기화
- 테스트 및 품질 관리
- 버그 수정 및 리팩토링
- 패키지 관리 및 배포

## 완료 현황 (2025-08-28)

### ✅ 완료된 핵심 기능들

#### 1. JSON 기반 시스템 프롬프트 (f07 통합 완성)
- `JsonSectionAssembler.ts`: 18개 JSON 섹션 로딩
- `CaretSystemPrompt.ts`: Plan/Act 의존성 0% 달성
- `sections/`: CHATBOT_AGENT_MODES.json 등 구조화된 프롬프트

#### 2. 백엔드 통합 (완성)
- `task/index.ts`: modeSystem 감지 및 Environment Details 처리
- `build-system-prompt.ts`: Caret 시스템 프롬프트 분기
- `ToolExecutor.ts`: chatbot_mode_respond 도구 처리

#### 3. 프론트엔드 UI (완성)
- `ChatTextArea.tsx`: modeSystem 기반 라벨 전환 ("Plan/Act" ↔ "Chatbot/Agent")
- `CaretModeSystemSetting.tsx`: 설정 UI 토글
- localStorage 기반 실시간 동기화

#### 4. Proto 시스템 확장 (완성)
- `state.proto`: modeSystem 필드 추가
- `caret-settings-conversion.ts`: 모드 시스템 변환 로직

### 📊 최종 달성 지표

| 목표              | 달성도  | 세부 사항                                  |
| ----------------- | ------- | ------------------------------------------ |
| **기능적 독립성** | ✅ 100% | Plan/Act 코드와 0% 의존성                  |
| **어댑터 패턴**   | ✅ 100% | ModeSystemRegistry 완전 구현               |
| **Factory 패턴**  | ✅ 100% | MessageHandler + ButtonConfig Factory 완성 |
| **JSON 프롬프트** | ✅ 100% | 18개 섹션 구조화 완료 (f07 통합)          |
| **UI 통합**       | ✅ 100% | 실시간 동기화 완성                         |
| **TDD 검증**      | ✅ 97%  | 38개 중 37개 테스트 통과                   |
| **머징 안전성**   | ✅ 96%  | Cline 파일 수정 5개로 최소화 달성          |
| **Agent 모드**    | ✅ 100% | Optimistic Update로 완전 동작              |
| **Chatbot 모드**  | ✅ 100% | 버튼 문제 해결로 완전 동작                 |

## Cline 호환성

### 완전 호환성 제공
기존 Cline 사용자를 위한 **완벽한 하위 호환성**:

| Caret Mode     | Cline Mode  | 설명           |
| -------------- | ----------- | -------------- |
| **💬 Chatbot** | **📋 Plan** | 대화/계획 중심 |
| **🤖 Agent**   | **⚡ Act**  | 실행/작업 중심 |

### 매끄러운 전환
- **기존 사용자**: 아무런 변경 없이 Plan/Act 모드 계속 사용
- **새로운 사용자**: 직관적인 Chatbot/Agent 모드 활용
- **혼합 사용**: 언제든지 Caret ↔ Cline 모드 전환 가능

## 주의사항

### 머징 시 주의사항
- [ ] 어댑터 패턴: ModeSystemRegistry 정상 동작 확인
- [ ] JSON 프롬프트: f07과 통합 구현 확인
- [ ] Factory 패턴: 완전 분리 아키텍처 확인
- [ ] 이중 보안: Chatbot 모드 도구 제한 정상 동작
- [ ] UI 호환성: Cline Act 모드와 동일한 동작 확인

### 완료 기준
- [ ] 42개 통합 테스트 통과
- [ ] 37개 TDD 테스트 통과
- [ ] End-to-End 테스트 통과
- [ ] UI 호환성 테스트 통과
- [ ] Agent 모드 대화 연속성 확인
- [ ] Chatbot 모드 안전 장치 확인
- [ ] 기존 Cline 사용자 워크플로우 100% 보존

## 예상 소요 시간
- **총 시간**: 10-12시간
- **복잡도**: HIGH
- **위험도**: LOW (완전 구현 완료로 안정성 검증됨)