# Luke Yang - t03-2 백엔드 메시지 i18n, 웰컴페이지 이식 (2단계)

**작업 기간**: 2025-08-31 ~ 진행중  
**담당자**: Luke Yang  
**우선순위**: Medium  
**AI 어시스턴트**: Claude Code

## 🎯 2단계 목표: 백엔드 메시지 i18n적용 노출(옵션), 웰컴페이지 및 각종 페이지 이식

### 2.1. 📋 caret 적용 주석 잘달어 잘하기 (i18n은 자동 전환 대상 아님)
- 백엔드 메시지 i18n 노출 옵션 시스템
- 웰컴페이지 및 각종 페이지 이식  
- **핵심 원칙**: i18n은 자동 전환 대상 아님 (수동 관리)

### 2.2. 📋 caret → codecenter 구축
- codecenter 브랜딩에 맞는 i18n 시스템
- codecenter 전용 백엔드 메시지 처리
- codecenterbot vs caretbot 템플릿 차별화

## 📋 기반 시스템 (1단계에서 완성됨)

### ✅ i18n 토글 시스템 파일들
1. **Frontend**: `/webview-ui/src/caret/i18n/brand-toggle.ts`
   - `getCurrentBrandMode()`, `isI18nEnabled()` 함수
   - 브랜드별 i18n 활성화/비활성화 제어
   - Cline 모드: i18n 비활성화, Caret 모드: i18n 활성화

2. **Backend**: `/src/core/messages/brand-aware-messages.ts`
   - `BrandAwareMessageFactory` 클래스
   - 브랜드별 메시지 처리 시스템
   - 백엔드 메시지 자동 브랜드명 치환

3. **Configuration**: `/caret-b2b/assets/brand-i18n.json`
   - 브랜드별 i18n 설정 (cline: false, caret: true, codecenter: true)
   - 백엔드 메시지 매핑 정의

## 📋 2단계 세부 구현 계획

### 🔧 2.1 Caret 백엔드 메시지 i18n 적용

#### **A. 백엔드 하드코딩 메시지 조사**
- `src/` 전체에서 "Cline wants", "Cline is" 등 패턴 검색
- 각 메시지별 i18n 키 매핑 정의
- brand-i18n.json의 backend_message_mappings 확장

#### **B. i18n 시스템 연동**
- 기존 i18n 시스템과 brand-toggle.ts 연동
- `processBackendMessage()` 함수 실제 구현
- 브랜드별 메시지 처리 로직 완성

#### **C. 웰컴페이지 및 각종 페이지 이식**
- WelcomeView, HomeHeader 등 주요 페이지
- 하드코딩 "Cline" 텍스트를 브랜드 토글 시스템으로 변경
- **주석 표준**: `// CARET MODIFICATION: i18n 브랜드 토글 적용`

### 🔧 2.2 CodeCenter i18n 구축

#### **A. CodeCenter 전용 설정**
- brand-i18n.json에 codecenter 백엔드 메시지 설정
- codecenterbot 템플릿 차별화 요소 정의

#### **B. 템플릿 시스템 확장**
- caretbot vs codecenterbot 차이점 분석
- 페르소나 시스템과의 연동 고려

## 🚨 중요 원칙

### Luke 지시사항
- **"i18n은 자동 전환 대상 아님"** - 브랜딩 스크립트에서 제외
- **"주석 잘 달기"** - 모든 수정에 한글 주석 필수  
- **단계별 허락** - 각 단계마다 확인 후 진행

### 기술적 제약사항
- 업스트림 머징 고려 - 최소한의 Cline 파일 수정
- CARET MODIFICATION 주석 표준 준수
- Level 1 독립 모듈 우선 활용

## 📋 현재 상태 (2025-08-31 업데이트)
- **1단계**: ✅ **100% 완료** (Luke 테스트 완료)
  - 1.1 cline ↔ caret: ✅ 완료 
  - 1.2 caret → codecenter: ✅ TDD 완료 (5/5 테스트 통과)
  - 1.3 이미지 리소스 전환: ✅ TDD 완료 (5/5 테스트 통과)
- **2단계**: 🔄 **시작됨** (백엔드 메시지 i18n 조사 중)

## 📋 2.1 백엔드 메시지 i18n 적용 - 현재 작업

### 🔍 웹뷰 백엔드 메시지 조사 결과
**목표**: 웹뷰로 전송되는 ClineMessage의 text 필드 중 하드코딩된 메시지를 i18n으로 번역

**발견된 메시지 유형**:
1. **시스템 알림**: `showSystemNotification` (OS 네이티브 - 제외)
2. **VS Code 메시지**: `HostProvider.window.showMessage` (VS Code UI - 제외)  
3. **웹뷰 메시지**: `ClineMessage.text` (웹뷰 표시 - ⭐ 타겟)

### 🚨 중요 발견 - 잘못된 접근법 수정 (2025-08-31)

**문제**: `/src/core/messages/brand-aware-messages.ts` 백엔드 파일 생성 - **잘못된 접근**
- Luke 지시: "백엔드는 수정없이 웹뷰에서 잡는거"
- 업스트림 머징 충돌 위험
- Level 1 독립 모듈 원칙 위배

**올바른 접근법**:
1. ✅ **백엔드**: 기존 하드코딩 메시지 그대로 전송 (수정 없음)
2. ⭐ **웹뷰**: 받은 `ClineMessage.text`를 i18n 필터링해서 표시

**수정 방향**:
```typescript
// 웹뷰에서 처리
const translatedMessage = translateBackendMessage(clineMessage.text)
```

### 📋 수정된 구현 계획

#### **Phase 1**: 백엔드 하드코딩 메시지 조사
- `ClineMessage.text`로 전송되는 모든 하드코딩 메시지 패턴 수집
- 예: "Cline wants to edit", "Task Completed", "API Request..." 등

#### **Phase 2**: 웹뷰 i18n 필터 구현 (⭐ **옵션 기능**)
- `/webview-ui/src/caret/i18n/backend-message-filter.ts` 생성
- 백엔드 메시지 → i18n 키 매핑 테이블
- TDD 기반 번역 함수 구현
- **옵션 토글**: 사용자가 백엔드 메시지 i18n을 켜고 끌 수 있음

#### **Phase 3**: 웹뷰 통합
- `ClineMessage` 렌더링 시점에서 필터 적용
- 브랜드 토글과 연동 (Cline: 원본, Caret: 번역)
- **옵션 UI**: 설정에서 "백엔드 메시지 번역" 토글 제공

### 🎯 옵션 기능 구현 사양

#### **연동 방식**: caret-main 기존 모드 설정 활용
- **기존 시스템**: caret-main 일반 설정의 caret/cline 모드 설정
- **원래 목적**: 시스템 프롬프트 설정 (아직 미이식)
- **현재 활용**: 백엔드 메시지 i18n 토글로도 사용

#### **동작 사양**
- **Cline 모드 켜면**: 백엔드 메시지 i18n **OFF** (영어 원본)
- **Caret 모드 켜면**: 백엔드 메시지 i18n **ON** (한국어 번역)

#### **구현 위치**
- **설정 UI**: caret-main 일반 설정의 기존 caret/cline 모드 토글 활용
- **웹뷰 이식**: 해당 설정 컴포넌트를 웹뷰로 이식 시 포함
- **우선순위**: 모드 설정 기능만 먼저 포함 (시스템 프롬프트는 나중)

### 🧹 수정 작업 진행사항

#### ✅ 완료된 작업
- 잘못된 백엔드 파일 삭제: `/src/core/messages/brand-aware-messages.ts`
- 올바른 접근법으로 방향 수정: 웹뷰 필터링 방식

#### 🔄 다음 단계 (대기 중)
- Phase 1: 백엔드 하드코딩 메시지 조사
- Phase 2: 웹뷰 i18n 필터 TDD 구현  
- Phase 3: 웹뷰 통합 및 테스트
- **추가**: caret-main의 caret/cline 모드 설정 컴포넌트 찾아서 웹뷰 이식 준비

#### 📋 기존 모드 설정 조사 필요
- caret-main에서 caret/cline 모드 토글 UI 위치 확인
- 설정 저장/로드 방식 파악
- 웹뷰 이식 시 통합 방안 검토

## 🧪 TDD 테스트 계획 (2025-08-31)

### 📋 테스트 전략

#### **RED-GREEN-REFACTOR 사이클**
1. **RED**: 실패하는 테스트 작성
2. **GREEN**: 최소한의 구현으로 통과
3. **REFACTOR**: 코드 품질 개선

#### **테스트 범위**
- ✅ 백엔드 메시지 패턴 매칭
- ✅ i18n 키 매핑 정확성  
- ✅ 브랜드 모드별 동작
- ✅ 옵션 토글 동작
- ✅ 에러 케이스 처리

### 📋 테스트 케이스 설계

#### **1. 백엔드 메시지 패턴 매칭 테스트**
```javascript
describe('Backend Message Pattern Matching', () => {
  test('should match "Cline wants to edit" pattern', () => {
    const message = "Cline wants to edit package.json"
    expect(isBackendMessage(message)).toBe(true)
    expect(getMessageType(message)).toBe('wants_to_edit')
  })
  
  test('should match "Task Completed" pattern', () => {
    const message = "Task Completed"
    expect(isBackendMessage(message)).toBe(true)
    expect(getMessageType(message)).toBe('task_completed')
  })
  
  test('should not match regular user messages', () => {
    const message = "Hello, how are you?"
    expect(isBackendMessage(message)).toBe(false)
  })
})
```

#### **2. i18n 키 매핑 테스트**
```javascript
describe('i18n Key Mapping', () => {
  test('should map "wants_to_edit" to Korean', () => {
    const result = translateBackendMessage('wants_to_edit', 'ko')
    expect(result).toBe('파일을 편집하려고 합니다')
  })
  
  test('should handle brand name replacement', () => {
    const result = translateBackendMessage('wants_to_edit', 'ko', { brandName: 'Caret' })
    expect(result).toContain('Caret')
  })
})
```

#### **3. 브랜드 모드별 동작 테스트**
```javascript
describe('Brand Mode Behavior', () => {
  test('should return original message in Cline mode', () => {
    const message = "Cline wants to edit file.js"
    const result = processBackendMessage(message, { mode: 'cline' })
    expect(result).toBe(message)
  })
  
  test('should translate message in Caret mode', () => {
    const message = "Cline wants to edit file.js"  
    const result = processBackendMessage(message, { mode: 'caret' })
    expect(result).toContain('파일을 편집하려고')
    expect(result).toContain('Caret')
  })
})
```

#### **4. 옵션 토글 테스트**
```javascript
describe('Option Toggle', () => {
  test('should disable i18n when toggle is off', () => {
    const message = "Cline wants to create new file"
    const result = processBackendMessage(message, { 
      mode: 'caret', 
      enableBackendI18n: false 
    })
    expect(result).toBe(message) // 원본 그대로
  })
  
  test('should enable i18n when toggle is on', () => {
    const message = "Cline wants to create new file"
    const result = processBackendMessage(message, { 
      mode: 'caret', 
      enableBackendI18n: true 
    })
    expect(result).not.toBe(message) // 번역됨
  })
})
```

#### **5. 에러 케이스 테스트**
```javascript
describe('Error Cases', () => {
  test('should handle unknown message types gracefully', () => {
    const message = "Unknown backend message format"
    expect(() => processBackendMessage(message)).not.toThrow()
  })
  
  test('should handle missing i18n keys', () => {
    const result = translateBackendMessage('nonexistent_key', 'ko')
    expect(result).toBe('nonexistent_key') // fallback
  })
})
```

### 📋 구현 파일 구조

#### **테스트 파일**
- `/webview-ui/src/caret/i18n/__tests__/backend-message-filter.test.ts`

#### **구현 파일**  
- `/webview-ui/src/caret/i18n/backend-message-filter.ts`
- `/webview-ui/src/caret/i18n/backend-message-mappings.json`

### 📋 테스트 실행 계획

#### **Phase 1**: 기본 패턴 매칭 (RED → GREEN)
- 백엔드 메시지 식별 함수
- 기본적인 패턴 매칭 로직

#### **Phase 2**: i18n 매핑 (RED → GREEN)  
- 메시지 타입별 번역 키 매핑
- 한국어 번역 데이터

#### **Phase 3**: 브랜드 모드 연동 (RED → GREEN)
- 모드별 분기 처리
- 브랜드명 치환 로직

#### **Phase 4**: 통합 및 리팩터링
- 전체 시스템 통합
- 코드 품질 개선

## 🚨 AI 업무 방법 가이드 준수 (Phase 0 체크)

### **업무 성격 분석**: Frontend-Backend 상호작용 관련
- **작업 내용**: 웹뷰에서 백엔드 메시지 i18n 필터링
- **해당 분야**: UI 설정, 상태 관리, 메시지 통신

### **필수 문서 체크 대상**
- `caret-docs/development/frontend-backend-interaction-patterns.mdx` ⚡ **MANDATORY**
- `caret-docs/development/caret-architecture-and-implementation-guide.mdx` (섹션 10-11)
- `caret-docs/development/message-processing-architecture.mdx`

### **아키텍처 결정**
- ✅ **Caret vs Cline**: 새 기능이므로 `webview-ui/src/caret/` 폴더 사용
- ✅ **백업 요구사항**: 백엔드 수정 없음, 웹뷰만 수정
- ✅ **테스트 파일**: `webview-ui/src/caret/**/*.test.ts` 위치

### **현재 상태**: Phase 0 ✅ 완료, TDD Phase 1 (RED) 진행 중

### **📋 TDD 진행 상황**

#### ✅ **Phase 0: 필수 문서 체크 완료**
- Frontend-Backend 상호작용 패턴 가이드 확인
- 아키텍처 결정: `webview-ui/src/caret/i18n/` 디렉토리 사용

#### 🔴 **Phase 1 (RED): 실패 테스트 작성 완료**
- 파일 생성: `/webview-ui/src/caret/i18n/__tests__/backend-message-filter.test.ts`
- **5개 테스트 그룹** 작성:
  1. 백엔드 메시지 패턴 매칭 (7개 테스트)
  2. i18n 키 매핑 (6개 테스트)  
  3. 브랜드 모드별 동작 (3개 테스트)
  4. 옵션 토글 동작 (3개 테스트)
  5. 에러 케이스 처리 (4개 테스트)
- **총 22개 테스트 케이스** 작성
- **현재 상태**: ✅ **모든 테스트 통과 (22/22)**

#### ✅ **Phase 2 (GREEN): 최소 구현 완료**
- 파일 생성: `/webview-ui/src/caret/i18n/backend-message-filter.ts`
- 파일 생성: `/webview-ui/src/caret/i18n/backend-message-mappings.json`
- **핵심 구현 완료**:
  - `isBackendMessage()`: 패턴 매칭으로 백엔드 메시지 식별
  - `getMessageType()`: 메시지 타입 분류
  - `translateBackendMessage()`: i18n 키 매핑 및 번역
  - `processBackendMessage()`: 메인 처리 함수
- **테스트 결과**: ✅ **22/22 통과** (100% 성공)

#### ✅ **Phase 3 (REFACTOR): 코드 품질 개선 완료**
- **타입 안전성 강화**: `SupportedLanguage`, `BrandMode`, `MessageType` 타입 정의
- **함수 문서화**: JSDoc으로 모든 공개 함수 문서화
- **코드 구조 개선**: 유틸리티 함수 분리 (`shouldAddBrandName`, `isValidMessage`)
- **에러 처리 강화**: 입력 검증 및 폴백 로직 개선
- **가독성 향상**: 변수명 개선, 주석 추가
- **최종 테스트**: ✅ **22/22 통과** (100% 유지)

## 🎯 **TDD 구현 최종 결과**

### ✅ **완성된 구현**
1. **핵심 파일**:
   - `/webview-ui/src/caret/i18n/backend-message-filter.ts` (242줄)
   - `/webview-ui/src/caret/i18n/backend-message-mappings.json` (38줄)
   - `/webview-ui/src/caret/i18n/__tests__/backend-message-filter.test.ts` (159줄)

2. **기능 커버리지**:
   - ✅ 7개 백엔드 메시지 패턴 지원
   - ✅ 한국어/영어 이중 언어 지원  
   - ✅ Cline/Caret 브랜드 모드 분기
   - ✅ 옵션 토글 (enableBackendI18n)
   - ✅ 에러 케이스 처리 (graceful fallback)

3. **사용법**:
```typescript
import { processBackendMessage } from '@/caret/i18n/backend-message-filter'

// Caret 모드에서 i18n 활성화
const translated = processBackendMessage("Cline wants to edit file.js", {
  mode: 'caret',
  enableBackendI18n: true,
  language: 'ko'
})
// 결과: "Caret이 파일을 편집하려고 합니다"

// Cline 모드에서는 원본 그대로
const original = processBackendMessage("Cline wants to edit file.js", {
  mode: 'cline'
})
// 결과: "Cline wants to edit file.js"
```

### 📊 **개발 성과**
- **TDD 사이클**: 완전한 RED-GREEN-REFACTOR 3단계 완주
- **단위 테스트**: 100% (22/22 테스트 통과)
- **코드 품질**: 타입 안전성, 문서화, 에러 처리 완비
- **아키텍처 준수**: Level 1 독립 모듈, 백엔드 무수정

### 🚧 **남은 작업 (미완료)**
1. **소스 통합**: 웹뷰 ClineMessage 렌더링에 필터 적용
2. **통합 테스트**: 실제 웹뷰에서 메시지 번역 확인
3. **모드 설정 연동**: caret-main의 Cline/Caret 모드 토글 이식
4. **E2E 테스트**: 전체 시스템 동작 확인

### ⚠️ **현재 상태**
- ✅ **Phase 1 완료**: i18n 필터링 시스템 단위 구현
- 🔄 **Phase 2 필요**: 웹뷰 통합 및 실제 동작 테스트
- 🔄 **Phase 3 필요**: 모드 설정 UI 연동

## 📋 발견된 하드코딩 텍스트 파일들 (추후 작업 대상)
- `/webview-ui/src/App.tsx`
- `/webview-ui/src/components/welcome/WelcomeView.tsx` 
- `/webview-ui/src/context/ClineAuthContext.tsx`
- `/webview-ui/src/components/welcome/HomeHeader.tsx`
- 기타 6개+ 파일