# t09 서버 측 텔레메트리 구현 계획

## 개요
Caret 서비스의 서버 측 텔레메트리 시스템을 구현하여 사용자 행동 분석, 성능 모니터링, 오류 추적을 통해 서비스 품질을 향상시키고자 함.

## 현재 상황 분석

### 클라이언트 측 텔레메트리 현황
- **TelemetryService**: PostHog를 사용한 클라이언트 측 이벤트 추적
- **개인정보 보호**: `isTelemetryEnabled` 플래그로 사용자 동의 확인
- **수집 데이터**: 
  - 사용자 행동 (task.created, task.completed, ui.model_selected)
  - API 성능 (token_usage, api_errors)
  - 기능 사용량 (browser_tool, mcp_tool, focus_chain)

### 개인정보 보호 현황
- ✅ 사용자 정보 전송 flag 제어 구현됨
- ✅ VSCode 텔레메트리 설정 연동 완료
- ✅ 개인정보 처리방침 URL 구성 완료
- ✅ 청소년 보호정책 URL 추가 완료

## 서버 측 텔레메트리 구현 계획

### 1. 아키텍처 설계

```
[Caret 클라이언트] → [서버 API 게이트웨이] → [텔레메트리 수집기] → [데이터 저장소]
                                              ↓
                                        [분석 엔진] → [대시보드]
```

### 2. 핵심 구성 요소

#### 2.1 텔레메트리 수집 API
```typescript
// 서버 측 엔드포인트 구조
POST /telemetry/events
{
  "event_type": "task.created",
  "user_id_hash": "hashed_user_id",
  "session_id": "session_uuid", 
  "timestamp": "2025-01-11T10:00:00Z",
  "properties": {
    "api_provider": "anthropic",
    "model": "claude-sonnet-4",
    "context_size": 128000
  },
  "client_info": {
    "version": "1.0.0",
    "platform": "vscode",
    "language": "ko"
  }
}
```

#### 2.2 데이터 수집 분류

**A. 성능 메트릭**
- API 응답 시간 (provider별, 모델별)
- 토큰 사용량 통계
- 오류율 및 실패 패턴
- 동시 사용자 수

**B. 기능 사용 패턴**
- 인기 모델 및 Provider 순위
- 기능별 사용빈도 (브라우저 도구, MCP, Focus Chain)
- 언어별 사용자 분포
- 세션 길이 및 활동 패턴

**C. 비즈니스 메트릭**
- 신규 사용자 유입/유지율
- 유료 전환율
- 크레딧 소비 패턴
- 지역별 사용량

### 3. 프라이버시 보호 조치

#### 3.1 데이터 최소화
```typescript
interface TelemetryEvent {
  // ✅ 수집하는 데이터
  event_type: string
  user_id_hash: string  // 해시된 사용자 ID
  timestamp: string
  session_id: string
  properties: Record<string, any>
  
  // ❌ 수집하지 않는 데이터
  // - 실제 코드 내용
  // - 파일 이름/경로 
  // - 개인 식별 정보
  // - 프롬프트 내용
}
```

#### 3.2 데이터 보관 정책
- **단기 데이터** (30일): 상세 이벤트 로그
- **중기 데이터** (1년): 집계된 메트릭
- **장기 데이터** (3년): 익명화된 트렌드 데이터
- **자동 삭제**: 설정된 기간 후 자동 삭제

#### 3.3 사용자 권리 보장
- **옵트아웃**: 언제든 텔레메트리 비활성화 가능
- **데이터 삭제**: 사용자 요청 시 개인 데이터 완전 삭제
- **투명성**: 수집되는 데이터 종류 명시

### 4. 기술 스택 제안

#### 4.1 수집 레이어
- **API Gateway**: AWS API Gateway 또는 Nginx
- **수집기**: Apache Kafka + Kafka Connect
- **실시간 처리**: Apache Storm 또는 AWS Kinesis

#### 4.2 저장 레이어
- **실시간 데이터**: Redis (세션 상태, 캐시)
- **시계열 데이터**: InfluxDB (성능 메트릭)
- **분석 데이터**: PostgreSQL (집계 데이터)
- **로그 저장소**: Elasticsearch

#### 4.3 분석 레이어
- **실시간 모니터링**: Grafana + Prometheus
- **데이터 파이프라인**: Apache Airflow
- **분석 엔진**: Python (Pandas, NumPy) 또는 Spark

### 5. 구현 단계

#### Phase 1: 기본 인프라 (4주)
- [ ] 텔레메트리 API 서버 구축
- [ ] 기본 이벤트 수집 시스템
- [ ] 데이터 저장소 설정
- [ ] 클라이언트 연동

#### Phase 2: 분석 시스템 (3주)
- [ ] 실시간 대시보드 구축
- [ ] 핵심 메트릭 정의 및 구현
- [ ] 알람 시스템 구축

#### Phase 3: 고급 분석 (4주)  
- [ ] 사용자 행동 분석
- [ ] 예측 분석 모델
- [ ] A/B 테스트 프레임워크

#### Phase 4: 운영 최적화 (2주)
- [ ] 성능 튜닝
- [ ] 보안 강화
- [ ] 모니터링 완성

### 6. 예상 비용 및 리소스

#### 6.1 인프라 비용 (월간 추정)
- **AWS/GCP 비용**: $500-1,500 (사용량에 따라)
- **모니터링 도구**: $100-300
- **데이터 저장**: $200-800

#### 6.2 개발 리소스
- **백엔드 개발자**: 2명 x 3개월
- **데브옵스 엔지니어**: 1명 x 2개월  
- **데이터 엔지니어**: 1명 x 2개월

### 7. 성공 지표 (KPI)

#### 7.1 기술적 지표
- 데이터 수집 성공률 > 99%
- API 응답 시간 < 100ms
- 데이터 파이프라인 지연 < 5분

#### 7.2 비즈니스 지표
- 사용자 활동 패턴 분석 정확도
- 오류 감지 및 대응 시간 단축
- 기능 개선을 위한 데이터 기반 의사결정

### 8. 리스크 및 대응책

#### 8.1 주요 리스크
- **개인정보 침해**: 철저한 데이터 최소화 및 암호화
- **성능 영향**: 비동기 처리 및 배치 업로드
- **데이터 누출**: 접근 권한 관리 및 보안 감사
- **규정 준수**: GDPR, 개인정보보호법 준수

#### 8.2 대응 방안
- 정기적인 보안 감사
- 데이터 처리 동의서 강화
- 투명한 데이터 사용 정책 공개
- 사용자 대시보드 제공

## 결론

서버 측 텔레메트리 구현을 통해 Caret 서비스의 품질 향상과 사용자 경험 개선이 가능할 것으로 예상됩니다. 개인정보 보호를 최우선으로 하여 점진적으로 구축해나가는 것이 중요합니다.

## 다음 단계
1. 경영진 승인 및 예산 확보
2. 개발팀 구성 및 일정 수립
3. Phase 1 구현 시작
4. 파일럿 테스트 및 피드백 수집